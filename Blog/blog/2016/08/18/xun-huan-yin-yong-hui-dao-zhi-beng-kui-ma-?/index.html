
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>循环引用会导致崩溃吗？ - IT Monkey Life</title>
	<meta name="author" content="Rick">

	
	<meta name="description" content="1
2
3
4
5
@weakify(self); return [RACSignal createSignal:^RACDisposable * (id&lt;RACSubscriber&gt; subscriber) { @strongify(self); return nil; }]; 在 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/Blog/atom.xml" rel="alternate" title="IT Monkey Life" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">IT Monkey Life</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:ITMonkeyLife.github.io/Blog/">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/Blog/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:ITMonkeyLife.github.io/Blog/">
	</form>
</nav>


</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">循环引用会导致崩溃吗？</h2>
	<div class="entry-content"><p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="err">@</span><span class="n">weakify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class="line">   <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span> <span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">       <span class="err">@</span><span class="n">strongify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class="line">       <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class="line">   <span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
在 <code>block</code> 没有调用前, <code>self delloc</code>了,在<code> block </code>里面<code> strongself </code>应该可以获取的变量，个人理解,<code>block </code>中的<code> self </code>算是局部变量,有<code> block </code>持有,销毁情况只跟<code> block </code>有关系</p>
<p>也有人说<code> strongSelf </code>只是保证在<code> block </code>里面有值，这样说也没错，我测试也是<code> strong </code>里面保持有值得，即使外部的<code> self </code>释放了，所以内部才用<code> strongSelf </code>啦</p>
<p>那平常我们在没有用这个框架的时候,都是用__weak,这样的话,<code> block </code>里边的<code>weakself</code>,在<code>self dealloc</code>后 , 还有么？dealloc 会置为 nil
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="n">__weak</span> <span class="n">typeof</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="n">weakself</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class="line">    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span> <span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class="line">    <span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>对于内部有多函数调用 用它有隐患,也就是说这样写,是不好的？</p>
<p>是的,这样可以避免<code>block</code>执行过程中<code>self</code>对象被释放</p>
<p>外部的 <code>weak</code> 是为了防止因为<code> self </code>导致的循环引用,但是如果这时候<code> self </code>被释放的话,内部的<code> weakself </code>就为空了,所以一般内部会用<code> __strong </code>生声明一下<code> __weak typeof(self) weakSelf = self; </code>最安全用法:block外部:<code>  __weak __typeof(self) weakSelf = self; </code>block内部:<code> __strong __typeof(weakSelf) strongSelf = weakSelf; </code>why:<code> weakSelf </code>是为了<code>block</code>不持有<code>self</code>, 避免循环引用, 而再声明一个<code>strongSelf</code>是因为一旦进入<code>block</code>执行, 就不允许<code>self</code>在这个执行过程中释放.<code> block</code>执行完成后这个<code>strongSelf</code>会自动释放, 没有循环引用问题.
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line">  <span class="n">__weak</span> <span class="n">typeof</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="n">weakSelf</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class="line">  <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class="line">    <span class="p">[</span><span class="n">weakSelf</span> <span class="n">doThis</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">weakSelf</span> <span class="n">doThat</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">Manager</span><span class="p">.</span><span class="n">sharedInstance</span> <span class="n">updateSuccessCount</span><span class="p">];</span>
</span><span class="line">  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
如上,<code>block</code>内部发送了两条消息, 如果只是一条, 那么采用<code>weakSelf</code>是没有问题的.但如果是两条消息,y通过看<code>Clang</code>的document能够看到, 以为<code>Clang</code>有可能会重新计算对象的引用计数, <code>weakSelf</code>有可能被置为nil, 这一过程发生在<code>block</code>内部执行完doThis之后, 还没有执行doThat之前.
我现在这外部<code> weakself </code>释放了,里面的<code> strongself </code>也跟着释放了.
<br />
<img src="http://ww4.sinaimg.cn/large/626e5d69gw1f6y6tdb3mvj20ks06ejso.jpg" alt="" />
<br />
那么这里用<code>weakself  </code>是不是不对呢？
刚才那里用<code>weakSelf</code>是没错的。为什么？
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="n">__weak</span> <span class="n">typeof</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="n">weakSelf</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class="line"><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class="line">      <span class="k">if</span><span class="p">(</span><span class="n">weakSelf</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">      <span class="n">__strong</span> <span class="n">typeof</span><span class="p">(</span><span class="n">weakSelf</span><span class="p">)</span> <span class="n">strongSelf</span> <span class="o">=</span> <span class="n">weakSelf</span><span class="p">;</span>
</span><span class="line">      <span class="p">[</span><span class="n">strongSelf</span> <span class="n">doThis</span><span class="p">];</span>
</span><span class="line">      <span class="p">[</span><span class="n">weakSelf</span> <span class="n">doThat</span><span class="p">];</span>
</span><span class="line">      <span class="p">[</span><span class="n">Manager</span><span class="p">.</span><span class="n">sharedInstance</span> <span class="n">updateSuccessCount</span><span class="p">];</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
内部的<code>typeof()</code>括号里面的是<code> weakSelf</code>啦
这样<code>block</code>会把<code>weakSelf</code>放到内部的一个持有变量表里面,我测试,当在内部强引用这<code> self</code>, 视图被销毁,先走 <code>delloc</code>, 然后<code> strongself </code>还是存在的。
不是有一个持有变量表么,按道理来讲<code>block</code>中的<code>weakself</code>,应该是一直有的啊<code>block</code>持有<code>weakSelf</code>，因为是<code>weak</code>变量所以不会增加引用计数。如果<code>self</code>对象在<code>block</code>执行之前就没有其他<code>strong</code>变量持有它，就会释放，后面<code>block</code>执行的时候<code>weakSelf</code>就已经是<code>nil</code>了。但是如果<code>block</code>开始执行，<code>strongSelf</code>又持有了<code>self</code>对象，这时候即使没有其他<code>strong</code>变量持有，<code>self</code>对象也不会释放。<code>block</code>执行完毕后，局部变量<code>strongSelf</code>被系统自动回收，这时候<code>self</code>变量引用计数会-1，如果没有其他变量持有，就会释放。总之，<code>strongSelf</code>不能确保<code>block</code>执行时<code>self</code>对象还存在，但是一旦开始执行时<code>self</code>还在，<code>strongSelf</code>可以给<code>self</code>续命到<code>block</code>执行结束
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="n">__weak</span> <span class="n">typeof</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="n">weakSelf</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class="line"><span class="p">[</span><span class="n">self</span> <span class="nl">doSomethingInBackgroundWithBlock:</span><span class="o">^</span><span class="p">{</span>
</span><span class="line">    <span class="n">__strong</span> <span class="n">typeof</span><span class="p">(</span><span class="n">weakSelf</span><span class="p">)</span> <span class="n">strongSelf</span> <span class="o">=</span> <span class="n">weakSelf</span><span class="p">;</span>
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">strongSelf</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="p">[</span><span class="n">strongSelf</span> <span class="n">doSomethingInBlock</span><span class="p">];</span>
</span><span class="line">        <span class="p">[</span><span class="n">strongSelf</span> <span class="n">doSomethingElseInBlock</span><span class="p">];</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>其实这里不if 倒也没关系，反正给nil发消息什么也不会发生。不过加上逻辑更明确。发送消息没关系，但是访问他的变量就完了
<img src="http://ww1.sinaimg.cn/large/626e5d69gw1f6y6vf2fhpj209204pgm4.jpg" alt="" />
<br />
这个就会崩溃。
嗯，循环引用大致是这样
</p>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog/">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog/">http://ITMonkeyLife.github.io/Blog/</a></p>
</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">

</div>
	
	<div class="comments"><a href="#disqus_thread">Comments</a></div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		
		<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
		
		
	</div>
	
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2016

    Rick

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'ITMonkeyLife';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ITMonkeyLife.github.io/Blog//Blog/blog/2016/08/18/xun-huan-yin-yong-hui-dao-zhi-beng-kui-ma-%3F/';
        var disqus_url = 'http://ITMonkeyLife.github.io/Blog//Blog/blog/2016/08/18/xun-huan-yin-yong-hui-dao-zhi-beng-kui-ma-%3F/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-52658428-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
