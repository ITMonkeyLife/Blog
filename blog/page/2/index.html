
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>IT Monkey Life</title>
	<meta name="author" content="Rick">

	
	<meta name="description" content="垂直的黑线将切分五线谱。 五线谱划分两个音符区。 节拍定义了每个区包含的不同种类的音符。 第一个区的节拍是 4/4 第二个区的节拍是 3/4 。 第一区 (4/4) 包含四个四分音符。 第二区(3/4) 包含三个四分音符。 接下来，我们将讨论非四分音符节拍。 6/8 包含了六个八分音符。 3/2 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/Blog/atom.xml" rel="alternate" title="IT Monkey Life" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/Blog/favicon.png" rel="shortcut icon">
	<link href="/Blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/Blog/">IT Monkey Life</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/Blog/">Blog</a></li>
	<li><a href="/Blog/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/Blog/">Blog</a></li>
	<li><a href="/Blog/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:ITMonkeyLife.github.io/Blog">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/Blog/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:ITMonkeyLife.github.io/Blog">
	</form>
</nav>


</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/09/07/yin-le-le-li-biao-zhun-yin-yu-jie-pai/">
		
			音乐乐理:标准音与节拍</a>
	</h2>
	<div class="entry-content">
		<div id="static">
<ul>
<li> 垂直的黑线将切分五线谱。<br /><img src="/Blog/images/music/lesson12_20@2x.png" />
<li> 五线谱划分两个音符区。 <br /><img src="/Blog/images/music/lesson12_40@2x.png" />
<li> 节拍定义了每个区包含的不同种类的音符。
<li> 第一个区的节拍是 4/4 第二个区的节拍是 3/4 。<br /><img src="/Blog/images/music/lesson12_60@2x.png" />
<li> 第一区 (4/4) 包含四个四分音符。<br /><img src="/Blog/images/music/lesson12_80@2x.png" />
<li> 第二区(3/4) 包含三个四分音符。<br /><img src="/Blog/images/music/lesson12_100@2x.png" />
<li> 接下来，我们将讨论非四分音符节拍。<br /><img src="/Blog/images/music/lesson12_120@2x.png" />
<li> 6/8 包含了六个八分音符。<br /><img src="/Blog/images/music/lesson12_140@2x.png" />
<li> 3/2 包含三个半音符。<br /><img src="/Blog/images/music/lesson12_160@2x.png" />
<li> 该图表显示了所有我们讨论的节拍。<br /><img src="/Blog/images/music/lesson12_161@2x.png" />


<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>
</li></li></li></li></li></li></li></li></li></li></ul></div>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/yin-le/'>音乐</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/09/07/yin-le-le-li-biao-zhun-yin-yu-jie-pai/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/09/06/yin-le-le-li-yin-fu-chi-xu-shi-jian/">
		
			音乐乐理:音符持续时间</a>
	</h2>
	<div class="entry-content">
		<div id="static">
<ul>
<li> 一个音符演奏的时间长度被称为它的音符时值，它是由音符的类型决定。<br /><img src="/Blog/images/music/lesson11_20@2x.png" />
<li> 该全音符在现代音乐最长的音符时值。<br /><img src="/Blog/images/music/lesson11_40@2x.png" />
<li> 二分音符具有全音符的一半的持续时间。<br /><img src="/Blog/images/music/lesson11_60@2x.png" />
<li> 两个半音符占据的时间相同为一体的全音符。<br /><img src="/Blog/images/music/lesson11_80@2x.png" />
<li> 四分音符为全音符的第四（或四分之一）。<br /><img src="/Blog/images/music/lesson11_100@2x.png" />
<li> 四个四分音符占据的时间相同为一体的全音符。两个四分音符等于一个半音符的持续时间。<br /><img src="/Blog/images/music/lesson11_120@2x.png" />
<li> 注意到，在持续时间小于四分音符有标志。每个标志减半音符的价值。<br /><img src="/Blog/images/music/lesson11_140@2x.png" />
<li> 八分音符有一个标志。<br /><img src="/Blog/images/music/lesson11_160@2x.png" />
<li> 因此，二个八分音符占用的时间相同数量的四分之一音符。<br /><img src="/Blog/images/music/lesson11_180@2x.png" />
<li> 一个十六分音符有两个标志，再减半值。<br /><img src="/Blog/images/music/lesson11_200@2x.png" />
<li> 两个十六分音符等于八分音符的持续时间。<br /><img src="/Blog/images/music/lesson11_220@2x.png" />
<li> 四个十六分音符占据的时间相同数量的四分之一音符。<br /><img src="/Blog/images/music/lesson11_240@2x.png" />
<li> 虽然可以有一个与三个或更多个标志音符，它们一般不使用。<br /><img src="/Blog/images/music/lesson11_260@2x.png" />
<li> 该图表显示在本节讨论的所有五种音符类型的关系。<br /><img src="/Blog/images/music/lesson11_261@2x.png" />


<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>
</li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul></div>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/yin-le/'>音乐</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/09/06/yin-le-le-li-yin-fu-chi-xu-shi-jian/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/09/06/yin-le-le-li-wu-xian-pu-%2Cpu-hao-%2Cjia-xian/">
		
			音乐乐理:五线谱，谱号，加线</a>
	</h2>
	<div class="entry-content">
		<p>
<code>五线谱</code>是对音符绘制的基础。现代的五线谱是由5根线和4个空间组成的。
<br />
<img src="http://ww2.sinaimg.cn/large/626e5d69gw1f7jn3flan2j21kw0lcdh6.jpg" />
在五线谱上的每行线或者空白处都表示键盘上的白建。
<br />
</p>

<p>
谱号分配给各个音符某些行或空格。
两个谱号经常用到，分别是：高音和低音。
<br />
<img src="http://ww3.sinaimg.cn/large/626e5d69gw1f7jqbp0363j21kw0lcq4r.jpg" />
<br />
我们先讨论高音（通常也称为G 谱）.该谱号环绕（显示为红色）五线谱线被称为G.放在该行的任何音符变成G.
<br />
G调以上的空白处的调是A调（记住，没有一个“H”调）
<br />
A调以上的调是B调。以此类推，G、A、B、C、D、E、F、G
<br />
<img src="http://ww1.sinaimg.cn/large/626e5d69gw1f7jqd7qzk5j21kw0lcdi6.jpg" />
额我们看来已经超过了五线谱的范围了，这时候该怎么办？
</p>

<p>
加线将解决我们的困境。
我们在五线谱之外，额外添加一条线，然后在这个线处继续添加A
<br />
<img src="http://ww2.sinaimg.cn/large/626e5d69gw1f7jsx3rujij21kw0lcdi5.jpg" />
</p>

		
		<a href="/Blog/blog/2016/09/06/yin-le-le-li-wu-xian-pu-%2Cpu-hao-%2Cjia-xian/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/yin-le/'>音乐</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/09/06/yin-le-le-li-wu-xian-pu-%2Cpu-hao-%2Cjia-xian/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/09/05/ios-tui-song-zheng-shu-guo-qi-zhi-nan/">
		
			iOS 推送证书过期指南</a>
	</h2>
	<div class="entry-content">
		<p>  
今天一早，运维部门同事，说咱们友盟上面推送证书已经到期了。那么到期了证书应该怎么样去更换新的证书呢。
</p>
<p>
1、我们先去<a href="https://developer.apple.com/account/ios/certificate/distribution">苹果开发者中心</a>新建一个Certificates证书。
</p>
<p>
2、下载<code>Cert</code>文件到本地，双击之后。在<code>Keychain Access</code>中找到我们创建的证书。Export导出p12格式，创建密码。
</p>
<p>
3、有时候后端需要pem格式的证书,我们通过终端进入p12 文件所在的文件夹，通过终端输入下面的命令生成pem文件
<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">openssl pkcs12 -in dev_push_Certificates.p12 -out apns-dev-cert.pem -nodes -clcerts
</span><span class="line">Enter Import Password:
</span><span class="line">MAC verified OK</span></code></pre></td></tr></table></div></figure></notextile></div>
</p>
<p>
4、生成证书后，只要替换Push证书就好了。
</p>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/09/05/ios-tui-song-zheng-shu-guo-qi-zhi-nan/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/29/ioskai-fa-jin-nang/">
		
			iOS开发锦囊</a>
	</h2>
	<div class="entry-content">
		<p>
1、判断是不是AppStore版本
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isAppStoreEnvironment</span> <span class="p">{</span>
</span><span class="line"><span class="cp">#if TARGET_OS_IOS &amp;&amp; !TARGET_IPHONE_SIMULATOR</span>
</span><span class="line">    <span class="k">return</span> <span class="p">([[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="nl">pathForResource:</span><span class="s">@&quot;embedded&quot;</span> <span class="nl">ofType:</span><span class="s">@&quot;mobileprovision&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class="line"><span class="cp">#endif</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="n">NO</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>
<p>
2、判断当前系统时区名称
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">currentSystemTimeZoneName</span> <span class="p">{</span>
</span><span class="line">    <span class="k">static</span> <span class="n">NSLock</span> <span class="o">*</span> <span class="n">methodLock</span><span class="p">;</span>
</span><span class="line">    <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">onceToken</span><span class="p">;</span>
</span><span class="line">    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class="line">        <span class="n">methodLock</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSLock</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class="line">    <span class="p">});</span>
</span><span class="line">
</span><span class="line">    <span class="p">[</span><span class="n">methodLock</span> <span class="n">lock</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">NSTimeZone</span> <span class="n">resetSystemTimeZone</span><span class="p">];</span>
</span><span class="line">    <span class="n">NSString</span> <span class="o">*</span> <span class="n">systemTimeZoneName</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSTimeZone</span> <span class="n">systemTimeZone</span><span class="p">].</span><span class="n">name</span> <span class="n">copy</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">methodLock</span> <span class="n">unlock</span><span class="p">];</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="n">systemTimeZoneName</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</p>

<p>
3、安全的执行method
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Performs selector on the target, only if the target and selector are non-nil,</span>
</span><span class="line"><span class="cm"> * as well as target responds to selector</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">safePerformSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">selector</span> <span class="nf">withTarget:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">target</span> <span class="nf">object:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">object</span> <span class="nf">object:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">anotherObject</span> <span class="p">{</span>
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="nb">nil</span> <span class="o">||</span> <span class="n">selector</span> <span class="o">==</span> <span class="nb">nil</span> <span class="o">||</span> <span class="o">!</span><span class="p">[</span><span class="n">target</span> <span class="nl">respondsToSelector:</span><span class="n">selector</span><span class="p">])</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="cp">#pragma clang diagnostic push</span>
</span><span class="line"><span class="cp">#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;</span>
</span><span class="line">    <span class="p">[</span><span class="n">target</span> <span class="nl">performSelector:</span><span class="n">selector</span> <span class="nl">withObject:</span><span class="n">object</span> <span class="nl">withObject:</span><span class="n">anotherObject</span><span class="p">];</span>
</span><span class="line"><span class="cp">#pragma clang diagnostic pop</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</p>
<p>
4、主线程执行
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nf">_newSystemLocationManager</span> <span class="p">{</span>
</span><span class="line">    <span class="n">__</span> <span class="n">block</span> <span class="n">CLLocationManager</span> <span class="o">*</span> <span class="n">manager</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// CLLocationManager should be created only on main thread, as it needs a run loop to serve delegate callbacks</span>
</span><span class="line">    <span class="n">dispatch_block_t</span> <span class="n">block</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class="line">        <span class="n">manager</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CLLocationManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class="line">    <span class="p">};</span>
</span><span class="line">    <span class="k">if</span> <span class="p">([</span><span class="n">NSThread</span> <span class="n">currentThread</span><span class="p">].</span><span class="n">isMainThread</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="n">block</span><span class="p">();</span>
</span><span class="line">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="line">        <span class="n">dispatch_sync</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="n">block</span><span class="p">);</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">manager</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</p>

<p>
5、添加Block
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addBlockForCurrentLocation:</span><span class="p">(</span><span class="n">PFLocationManagerLocationUpdateBlock</span><span class="p">)</span><span class="nv">handler</span> <span class="p">{</span>
</span><span class="line">    <span class="k">@synchronized</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">blockSet</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">blockSet</span> <span class="nl">addObject:</span><span class="p">[</span><span class="n">handler</span> <span class="n">copy</span><span class="p">]];</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="c1">//</span>
</span><span class="line">    <span class="c1">// Abandon hope all ye who enter here.</span>
</span><span class="line">    <span class="c1">// Apparently, the CLLocationManager API is different for iOS/OSX/watchOS/tvOS up to the point,</span>
</span><span class="line">    <span class="c1">// where encapsulating pieces together just makes much more sense</span>
</span><span class="line">    <span class="c1">// than hard to human-parse compiled out pieces of the code.</span>
</span><span class="line">    <span class="c1">// This looks duplicated, slightly, but very much intentional.</span>
</span><span class="line">    <span class="c1">//</span>
</span><span class="line"><span class="cp">#if TARGET_OS_WATCH</span>
</span><span class="line">    <span class="k">if</span> <span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">bundle</span> <span class="nl">objectForInfoDictionaryKey:</span><span class="s">@&quot;NSLocationWhenInUseUsageDescription&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">requestWhenInUseAuthorization</span><span class="p">];</span>
</span><span class="line">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="line">        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">requestAlwaysAuthorization</span><span class="p">];</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">requestLocation</span><span class="p">];</span>
</span><span class="line"><span class="cp">#elif TARGET_OS_TV</span>
</span><span class="line">    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">requestWhenInUseAuthorization</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">requestLocation</span><span class="p">];</span>
</span><span class="line"><span class="cp">#elif TARGET_OS_IOS</span>
</span><span class="line">    <span class="k">if</span> <span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="nl">respondsToSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="n">requestAlwaysAuthorization</span><span class="p">)])</span> <span class="p">{</span>
</span><span class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">application</span><span class="p">.</span><span class="n">applicationState</span> <span class="o">!=</span> <span class="n">UIApplicationStateBackground</span> <span class="o">&amp;&amp;</span>
</span><span class="line">            <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">bundle</span> <span class="nl">objectForInfoDictionaryKey:</span><span class="s">@&quot;NSLocationWhenInUseUsageDescription&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">            <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">requestWhenInUseAuthorization</span><span class="p">];</span>
</span><span class="line">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="line">            <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">requestAlwaysAuthorization</span><span class="p">];</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">startUpdatingLocation</span><span class="p">];</span>
</span><span class="line"><span class="cp">#elif PF_TARGET_OS_OSX</span>
</span><span class="line">    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">startUpdatingLocation</span><span class="p">];</span>
</span><span class="line"><span class="cp">#endif</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</p>

<p>
6、安全执行线程
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>
</span><span class="line"><span class="k">extern</span> <span class="n">dispatch_queue_t</span> <span class="nf">JPThreadsafetyCreateQueueForObject</span><span class="p">(</span><span class="kt">id</span> <span class="n">object</span><span class="p">);</span>
</span><span class="line"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">JPThreadsafetySafeDispatchSync</span><span class="p">(</span><span class="n">dispatch_queue_t</span> <span class="n">queue</span><span class="p">,</span> <span class="n">dispatch_block_t</span> <span class="n">block</span><span class="p">);</span>
</span><span class="line"><span class="cp">#define JPThreadSafetyPerform(queue, block) ({                      \</span>
</span><span class="line"><span class="cp">    __ block typeof((block())) result;                              \</span>
</span><span class="line"><span class="cp">    JPThreadsafetySafeDispatchSync(queue, ^{ result = block(); }); \</span>
</span><span class="line"><span class="cp">    result;                                                        \</span>
</span><span class="line"><span class="cp">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#import &quot;JPThreadsafety.h&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="k">const</span> <span class="n">JPThreadsafetyQueueIDKey</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JPThreadsafetyQueueIDKey</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="n">dispatch_queue_t</span> <span class="nf">JPThreadsafetyCreateQueueForObject</span><span class="p">(</span><span class="kt">id</span> <span class="n">object</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="n">NSString</span><span class="o">*</span> <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSStringFromClass</span><span class="p">([</span><span class="n">object</span> <span class="n">class</span><span class="p">])</span> <span class="nl">stringByAppendingString:</span><span class="s">@&quot;.synchronizationQueue&quot;</span><span class="p">];</span>
</span><span class="line">    <span class="n">dispatch_queue_t</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="n">label</span><span class="p">.</span><span class="n">UTF8String</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_SERIAL</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="kt">void</span><span class="o">*</span> <span class="n">uuid</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uuid</span><span class="p">));</span>
</span><span class="line">    <span class="n">dispatch_queue_set_specific</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">JPThreadsafetyQueueIDKey</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="n">queue</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kt">void</span> <span class="nf">JPThreadsafetySafeDispatchSync</span><span class="p">(</span><span class="n">dispatch_queue_t</span> <span class="n">queue</span><span class="p">,</span> <span class="n">dispatch_block_t</span> <span class="n">block</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="kt">void</span><span class="o">*</span> <span class="n">uuidMine</span> <span class="o">=</span> <span class="n">dispatch_get_specific</span><span class="p">(</span><span class="n">JPThreadsafetyQueueIDKey</span><span class="p">);</span>
</span><span class="line">    <span class="kt">void</span><span class="o">*</span> <span class="n">uuidOther</span> <span class="o">=</span> <span class="n">dispatch_queue_get_specific</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">JPThreadsafetyQueueIDKey</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">uuidMine</span> <span class="o">==</span> <span class="n">uuidOther</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="n">block</span><span class="p">();</span>
</span><span class="line">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="line">        <span class="n">dispatch_sync</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</p>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>
</p></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/29/ioskai-fa-jin-nang/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/26/method-swizzling/">
		
			Method Swizzling</a>
	</h2>
	<div class="entry-content">
		<p>
在没有一个类的实现源码的情况下，想改变其中一个方法的实现，除了继承它重写、和借助类别重名方法暴力抢先之外，还有更加灵活的方法吗？在Objective-C编程中，如何实现hook呢？标题有点大，计划分几篇来总结。

本文主要介绍针对selector的hook，主角被标题剧透了———— Method Swizzling
</p>
<h2>Method Swizzling 原理</h2>
<p>在Objective-C中调用一个方法，其实是向一个对象发送消息，查找消息的唯一依据是selector的名字。利用Objective-C的动态特性，可以实现在运行时偷换selector对应的方法实现，达到给方法挂钩的目的。</p>
<p>每个类都有一个方法列表，存放着selector的名字和方法实现的映射关系。IMP有点类似函数指针，指向具体的Method实现。</p>
<p><img src="http://ww3.sinaimg.cn/large/626e5d69gw1f76wrdzvssj214y0dcmxy.jpg" /></p>
<p>
我们可以利用 method_exchangeImplementations 来交换2个方法中的IMP，

我们可以利用 class_replaceMethod 来修改类，

我们可以利用 method_setImplementation 来直接设置某个方法的IMP，
……
归根结底，都是偷换了selector的IMP，如下图所示：
</p>
<p><img src="http://ww2.sinaimg.cn/large/626e5d69gw1f76wshrop2j20kf09mt95.jpg" /></p>
<h2>Method Swizzling 实践</h2>
<p>

举个例子好了，我想钩一下NSArray的lastObject 方法，只需两个步骤。
第一步：给NSArray加一个我自己的lastObject
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#import &quot;NSArray+Swizzle.h&quot;  </span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">@implementation</span> <span class="nc">NSArray</span> <span class="nl">(Swizzle)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">myLastObject</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="kt">id</span> <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="n">myLastObject</span><span class="p">];</span>
</span><span class="line">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;**********  myLastObject *********** &quot;</span><span class="p">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
乍一看，这不递归了么？别忘记这是我们准备调换IMP的selector，[self myLastObject] 将会执行真的 [self lastObject] 。
</p>
<p>
第二步：调换IMP
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#import &lt;objc/runtime.h&gt;  </span>
</span><span class="line"><span class="cp">#import &quot;NSArray+Swizzle.h&quot;  </span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="err">@</span><span class="n">autoreleasepool</span> <span class="p">{</span>
</span><span class="line">
</span><span class="line">        <span class="n">Method</span> <span class="n">ori_Method</span> <span class="o">=</span>  <span class="n">class_getInstanceMethod</span><span class="p">([</span><span class="n">NSArray</span> <span class="n">class</span><span class="p">],</span> <span class="k">@selector</span><span class="p">(</span><span class="n">lastObject</span><span class="p">));</span>
</span><span class="line">        <span class="n">Method</span> <span class="n">my_Method</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">([</span><span class="n">NSArray</span> <span class="n">class</span><span class="p">],</span> <span class="k">@selector</span><span class="p">(</span><span class="n">myLastObject</span><span class="p">));</span>
</span><span class="line">        <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">ori_Method</span><span class="p">,</span> <span class="n">my_Method</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">NSArray</span><span class="o">*</span> <span class="n">array</span> <span class="o">=</span> <span class="err">@</span><span class="p">[</span><span class="s">@&quot;0&quot;</span><span class="p">,</span><span class="s">@&quot;1&quot;</span><span class="p">,</span><span class="s">@&quot;2&quot;</span><span class="p">,</span><span class="s">@&quot;3&quot;</span><span class="p">];</span>
</span><span class="line">        <span class="n">NSString</span><span class="o">*</span> <span class="n">string</span> <span class="o">=</span> <span class="p">[</span><span class="n">array</span> <span class="n">lastObject</span><span class="p">];</span>
</span><span class="line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;TEST RESULT : %@&quot;</span><span class="p">,</span><span class="n">string</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</p>

		
		<a href="/Blog/blog/2016/08/26/method-swizzling/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/26/method-swizzling/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/min-gan-luo-ji-de-bao-hu-fang-an/">
		
			敏感逻辑的保护方案</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">24</span> <span class="title">敏感逻辑的保护方案</span></h1>
    <p>Objective-C 代码容易被 hook，暴露信息太赤裸裸，为了安全，改用 C 来写吧！</p>

<div class="figure" id="figure-24-1">
    <img src="http://ww2.sinaimg.cn/large/626e5d69gw1f760k4kot8j205p04gdfu.jpg" />

    <p class="caption"><strong>图片 24.1</strong> sensitive1</p>
</div>


<p>当然不是全部代码都要 C 来写，我指的是敏感业务逻辑代码。</p>

<p>本文就介绍一种低学习成本的，简易的，Objective-C 逻辑代码重写为 C 代码的办法。</p>

<p>也许，程序中存在一个类似这样的类：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">@interface</span> <span class="nc">XXUtil</span> : <span class="nc">NSObject</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isVerified</span><span class="p">;</span>
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isNeedSomething</span><span class="p">;</span>
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">resetPassword:</span><span class="p">(</span><span class="n">NSString</span><span class="o">*</span><span class="p">)</span><span class="nv">password</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>被 class-dump 出来后，利用 Cycript 很容易实现攻击，容易被 hook ，存在很大的安全隐患。</p>

<div class="figure" id="figure-24-2">
    <img src="http://ww2.sinaimg.cn/large/626e5d69gw1f760knfbzhj20350360sm.jpg" />

    <p class="caption"><strong>图片 24.2</strong> sensitive2</p>
</div>


<p>想改，但是不想大改程序结构，肿么办呢？</p>

<p>把函数名隐藏在结构体里，以函数指针成员的形式存储。
这样做的好处是，编译后，只留了下地址，去掉了名字和参数表，提高了逆向成本和攻击门槛。</p>

<p>改写的程序如下：</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="c1">//XXUtil.h  </span>
</span><span class="line"> <span class="err">#</span><span class="n">import</span> <span class="o">&lt;</span><span class="n">Foundation</span><span class="o">/</span><span class="n">Foundation</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_util</span> <span class="p">{</span>
</span><span class="line">    <span class="kt">BOOL</span> <span class="p">(</span><span class="o">*</span><span class="n">isVerified</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</span><span class="line">    <span class="kt">BOOL</span> <span class="p">(</span><span class="o">*</span><span class="n">isNeedSomething</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</span><span class="line">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">resetPassword</span><span class="p">)(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">password</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span><span class="n">XXUtil_t</span> <span class="p">;</span>
</span><span class="line">
</span><span class="line"> <span class="err">#</span><span class="n">define</span> <span class="n">XXUtil</span> <span class="p">([</span><span class="n">_XXUtil</span> <span class="n">sharedUtil</span><span class="p">])</span>
</span><span class="line">
</span><span class="line"><span class="k">@interface</span> <span class="nc">_XXUtil</span> : <span class="nc">NSObject</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">XXUtil_t</span> <span class="o">*</span><span class="p">)</span><span class="nf">sharedUtil</span><span class="p">;</span>
</span><span class="line"><span class="k">@end</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="c1">//XXUtil.m  </span>
</span><span class="line"> <span class="err">#</span><span class="n">import</span> <span class="s">&quot;XXUtil.h&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="kt">BOOL</span> <span class="n">_isVerified</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="c1">//bala bala ...  </span>
</span><span class="line">    <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="kt">BOOL</span> <span class="n">_isNeedSomething</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="c1">//bala bala ...  </span>
</span><span class="line">    <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="n">_resetPassword</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">password</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="c1">//bala bala ...  </span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="n">XXUtil_t</span> <span class="o">*</span> <span class="n">util</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class="line"><span class="k">@implementation</span> <span class="nc">_XXUtil</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span><span class="p">(</span><span class="n">XXUtil_t</span> <span class="o">*</span><span class="p">)</span><span class="nf">sharedUtil</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">onceToken</span><span class="p">;</span>
</span><span class="line">    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class="line">        <span class="n">util</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">XXUtil_t</span><span class="p">));</span>
</span><span class="line">        <span class="n">util</span><span class="o">-&gt;</span><span class="n">isVerified</span> <span class="o">=</span> <span class="n">_isVerified</span><span class="p">;</span>
</span><span class="line">        <span class="n">util</span><span class="o">-&gt;</span><span class="n">isNeedSomething</span> <span class="o">=</span> <span class="n">_isNeedSomething</span><span class="p">;</span>
</span><span class="line">        <span class="n">util</span><span class="o">-&gt;</span><span class="n">resetPassword</span> <span class="o">=</span> <span class="n">_resetPassword</span><span class="p">;</span>
</span><span class="line">    <span class="p">});</span>
</span><span class="line">    <span class="k">return</span> <span class="n">util</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">destroy</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">util</span> <span class="o">?</span> <span class="n">free</span><span class="p">(</span><span class="n">util</span><span class="p">)</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line">    <span class="n">util</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>最后，根据 Xcode 的报错指引，把以前这样的调用
<code>[XXUtil isVerified];</code></p>

<p>对应改成：
<code>XXUtil-&gt;isVerified();</code></p>

<p>就可以了。</p>

<p>是的，绝不费一点脑子。</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/min-gan-luo-ji-de-bao-hu-fang-an/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/objective-c-dai-ma-hun-yao/">
		
			Objective-C 代码混淆</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">23</span> <span class="title">Objective-C 代码混淆</span></h1>
    <p>class-dump 可以很方便的导出程序头文件，不仅让攻击者了解了程序结构方便逆向，还让着急赶进度时写出的欠完善的程序给同行留下笑柄。
所以，我们迫切的希望混淆自己的代码。</p>

<h3>混淆的常规思路</h3>

<p>混淆分许多思路，比如：</p>

<p>1）花代码花指令，即随意往程序中加入迷惑人的代码指令</p>

<p>2）易读字符替换 等等</p>

<div class="figure" id="figure-23-1">
    <img src="http://ww2.sinaimg.cn/large/626e5d69gw1f760g4dzitj202o031dfp.jpg" />

    <p class="caption"><strong>图片 23.1</strong> confusion1</p>
</div>


<p>防止 class-dump 出可读信息的有效办法是易读字符替换。</p>

<h3>Objective-C 的方法名混淆</h3>

<h4>混淆的时机</h4>

<p>我们希望在开发时一直保留清晰可读的程序代码，方便自己。
同时，希望编译出来的二进制包含乱七八糟的混淆后的程序代码，恶心他人。</p>

<p>因此，我们可以在 Build Phrase 中设定在编译之前进行方法名的字符串替换。</p>

<h4>混淆的方法</h4>

<p>方法名混淆其实就是字符串替换，有 2 个方法可以，一个是 <code>#define</code>，一个是利用 tops。</p>

<p>利用 <code>#define</code> 的方法有一个好处，就是可以把混淆结果合并在一个 .h 中，在工程 Prefix.pch 的最前面 <code>#import</code> 这个 .h 。不导入也可以编译、导入则实现混淆。</p>

<p>单段的 selector ，如 <code>func:</code> ，可以通过 <code>#define func</code> 来实现字符串替换。</p>

<p>多段的 selector，如 <code>a:b:c:</code> ，可以通过分别 <code>#define a 、b、c</code> 来实现字符串替换。</p>

<h3>我的混淆工具</h3>

<p>我写了个简易的混淆脚本，主要思路是把敏感方法名集中写在一个名叫 func.list 的文件中，逐一 <code>#define</code> 成随机字符，追加写入 .h 。</p>

<p>脚本如下：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
</pre></td><td class="code"><pre><code class=""><span class="line">#!/usr/bin/env bash  
</span><span class="line">
</span><span class="line">TABLENAME=symbols  
</span><span class="line">SYMBOL_DB_FILE="symbols"  
</span><span class="line">STRING_SYMBOL_FILE="func.list"  
</span><span class="line">HEAD_FILE="$PROJECT_DIR/$PROJECT_NAME/codeObfuscation.h"  
</span><span class="line">export LC_CTYPE=C  
</span><span class="line">
</span><span class="line">#维护数据库方便日后作排重  
</span><span class="line">createTable()  
</span><span class="line">{  
</span><span class="line">   echo "create table $TABLENAME(src text, des text);" | sqlite3 $SYMBOL_DB_FILE  
</span><span class="line">}  
</span><span class="line">
</span><span class="line">insertValue()  
</span><span class="line">{  
</span><span class="line">   echo "insert into $TABLENAME values('$1' ,'$2');" | sqlite3 $SYMBOL_DB_FILE  
</span><span class="line">}  
</span><span class="line">
</span><span class="line">query()  
</span><span class="line">{  
</span><span class="line">   echo "select * from $TABLENAME where src='$1';" | sqlite3 $SYMBOL_DB_FILE  
</span><span class="line">}  
</span><span class="line">
</span><span class="line">ramdomString()  
</span><span class="line">{  
</span><span class="line">   openssl rand -base64 64 | tr -cd 'a-zA-Z' |head -c 16  
</span><span class="line">}  
</span><span class="line">
</span><span class="line">rm -f $SYMBOL_DB_FILE  
</span><span class="line">rm -f $HEAD_FILE  
</span><span class="line">createTable  
</span><span class="line">
</span><span class="line">touch $HEAD_FILE  
</span><span class="line">echo '#ifndef Demo_codeObfuscation_h  
</span><span class="line">#define Demo_codeObfuscation_h' &gt;&gt; $HEAD_FILE  
</span><span class="line">echo "//confuse string at `date`" &gt;&gt; $HEAD_FILE  
</span><span class="line">cat "$STRING_SYMBOL_FILE" | while read -ra line; do  
</span><span class="line">   if [[ ! -z "$line" ]]; then  
</span><span class="line">       ramdom=`ramdomString`  
</span><span class="line">       echo $line $ramdom  
</span><span class="line">       insertValue $line $ramdom  
</span><span class="line">       echo "#define $line $ramdom" &gt;&gt; $HEAD_FILE  
</span><span class="line">   fi  
</span><span class="line">done  
</span><span class="line">echo "#endif" &gt;&gt; $HEAD_FILE  
</span><span class="line">
</span><span class="line">
</span><span class="line">sqlite3 $SYMBOL_DB_FILE .dump</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4>操作步骤</h4>

<p>1.将混淆脚本 confuse.sh 放到工程目录下
<code>mv confuse.sh your_proj_path/</code></p>

<p>2.修改 Prefix.pch</p>

<p>打开 Xcode，修改 XXX-Prefix.ch ，添加混淆头文件:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#ifdef __OBJC__  </span>
</span><span class="line">   <span class="err">#</span><span class="n">import</span> <span class="o">&lt;</span><span class="n">UIKit</span><span class="o">/</span><span class="n">UIKit</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class="line">   <span class="err">#</span><span class="n">import</span> <span class="o">&lt;</span><span class="n">Foundation</span><span class="o">/</span><span class="n">Foundation</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class="line">   <span class="c1">//添加混淆作用的头文件（这个文件名是脚本confuse.sh中定义的）  </span>
</span><span class="line">   <span class="err">#</span><span class="n">import</span> <span class="s">&quot;codeObfuscation.h&quot;</span>
</span><span class="line"><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>3.配置 Build Phase</p>

<p>在工程 Build Phase 中添加执行脚本操作，执行 confuse.sh 脚本，如图：</p>

<div class="figure" id="figure-23-2">
    <img src="http://ww3.sinaimg.cn/large/626e5d69gw1f760gkuq1ej20z80eqjtx.jpg" />

    <p class="caption"><strong>图片 23.2</strong> confusion3</p>
</div>


<p>4.创建函数名列表 func.list ，写入待混淆的函数名，如:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sample</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">seg1:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">string</span> <span class="nf">seg2:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span><span class="nv">num</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>就这样写：</p>

<p>sample<br />
seg1<br />
seg2</p>

<p>并将文件放置于与 confuse.sh 脚本同级<br />
<code>mv func.list your_proj_path/</code></p>

<p>5.编译查看结果</p>

<p>直接 build，混淆脚本会在编译前运行，进行字符随机替换，并且每次 build 的随机字符不同，如图：</p>

<div class="figure" id="figure-23-3">
    <img src="http://ww1.sinaimg.cn/large/626e5d69gw1f760hdde9nj20w40ecwjs.jpg" />

    <p class="caption"><strong>图片 23.3</strong> confusion4</p>
</div>


</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/objective-c-dai-ma-hun-yao/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/static-he-bei-cai-de-fu-hao-biao/">
		
			Static 和被裁的符号表</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">22</span> <span class="title">static 和被裁的符号表</span></h1>
    <p>为了不让攻击者理清自己程序的敏感业务逻辑，于是我们想方设法提高逆向门槛。</p>

<p>本文就介绍一个防御技巧——利用 static 关键字裁掉函数符号。</p>

<h3>原理</h3>

<p>如果函数属性为 static ，那么编译时该函数符号就会被解析为 local 符号。</p>

<p>在发布 release 程序时（用 Xcode 打包编译二进制）默认会 strip 裁掉这些函数符号，无疑给逆向者加大了工作难度。</p>

<h3>验证</h3>

<p>写个 demo 验证一下上述理论，以一段创建 Button 的代码为例，对应补充一个 static 版本。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="kt">id</span> <span class="nf">createBtn</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">UIButton</span> <span class="o">*</span><span class="n">btn</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIButton</span> <span class="n">alloc</span><span class="p">]</span><span class="nl">initWithFrame:</span><span class="n">CGRectZero</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">btn</span> <span class="nl">setFrame:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)];</span>
</span><span class="line">    <span class="p">[</span><span class="n">btn</span> <span class="nl">setBackgroundColor:</span><span class="p">[</span><span class="n">UIColor</span> <span class="n">redColor</span><span class="p">]];</span>
</span><span class="line">    <span class="n">btn</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">cornerRadius</span> <span class="o">=</span> <span class="mf">7.0f</span><span class="p">;</span>
</span><span class="line">    <span class="n">btn</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">masksToBounds</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class="line">    <span class="k">return</span> <span class="n">btn</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="kt">id</span> <span class="nf">static_createBtn</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">UIButton</span> <span class="o">*</span><span class="n">btn</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIButton</span> <span class="n">alloc</span><span class="p">]</span><span class="nl">initWithFrame:</span><span class="n">CGRectZero</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">btn</span> <span class="nl">setFrame:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)];</span>
</span><span class="line">    <span class="p">[</span><span class="n">btn</span> <span class="nl">setBackgroundColor:</span><span class="p">[</span><span class="n">UIColor</span> <span class="n">blueColor</span><span class="p">]];</span>
</span><span class="line">    <span class="n">btn</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">cornerRadius</span> <span class="o">=</span> <span class="mf">7.0f</span><span class="p">;</span>
</span><span class="line">    <span class="n">btn</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">masksToBounds</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class="line">    <span class="k">return</span> <span class="n">btn</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>再来看一下反编的结果，对于 createBtn() 方法，我们可以得到它的伪代码：</p>

<div class="figure" id="figure-22-1">
    <img src="http://ww1.sinaimg.cn/large/626e5d69gw1f760d9iqmfj20ns10aakb.jpg" />

    <p class="caption"><strong>图片 22.1</strong> static</p>
</div>


<p>函数名虽然面目全非，但是基本操作还是清晰的。</p>

<p>对于<code>static_createBtn() </code>方法呢，我们已经无法看到它任何直观的有价值信息了。</p>

<h3>局限</h3>

<p>当然这种方法也有局限性。正如你所知道的，<code>static </code>函数，只在本文件可见。</p>

<h3>打破局限</h3>

<p>怎么让别的文件也能调到本文件的<code> static </code>方法呢？</p>

<p>在本文件建造一个结构体，结构体里包含函数指针。把<code> static </code>函数的函数指针都赋在这个结构体里，再把这个结构体抛出去。</p>

<p>这样做的好处是，既隐藏了函数代码也丰富了调用方式。</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/static-he-bei-cai-de-fu-hao-biao/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/fei-chu-ying-yong-cheng-xu-de-aslrte-xing/">
		
			废除应用程序的 ASLR特性</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">21</span> <span class="title">废除应用程序的 ASLR 特性</span></h1>
    <p>ASLR (Address Space Layout Randomization)，即地址空间随机布局。大部分主流的操作系统都已实现了 ASLR，以防范对已知地址进行恶意攻击。iOS 从 4.3 开始支持 ASLR，Android 从 4.0 也支持了 ASLR 机制。</p>

<p>ASLR 的存在，给 iOS 系统越狱造成了很大的困难，某些不完美越狱方案就是因为攻破不了或者绕不开 ASLR ，所以每次重新启动后地址再度随机偏移，需要重新进行越狱操作。与此同时，ASLR 也给应用层攻击带来了一些困难，不同进程会造成不同的地址空间偏移，而且在运行时才可确定其偏移量，不易锁定攻击地址。</p>

<p><code>Mach-O </code>文件的文件头会记录二进制的属性标识，有个 flag 叫做 PIE  (Position Independent Enable)。开启了 PIE 的二进制文件，在执行时会产生 ASLR 。</p>

<p>我们可以使用<code> otool </code>工具，来查看任意应用程序二进制文件的属性，以支付宝为例：<br />
<code>otool -hv Portal</code></p>

<div class="figure" id="figure-21-1">
    <img src="http://ww3.sinaimg.cn/large/626e5d69gw1f7607zmgrxj216a032ju4.jpg" />

    <p class="caption"><strong>图片 21.1</strong> aslr</p>
</div>


<p>有 PIE 标识，表示该程序在启动时会产生随机地址布局。</p>

<div class="figure" id="figure-21-2">
    <img src="http://ww4.sinaimg.cn/large/626e5d69gw1f7608woa04j202m02s3yc.jpg" />

    <p class="caption"><strong>图片 21.2</strong> aslr1</p>
</div>
<a href="https://github.com/peterfillmore/removePIE">removePIE</a> 是个去掉 PIE flag 的工具。

<p>坏消息是，年久失修，它不支持 iOS7 。
好消息是，我们还有 2 个变通方法可以走。<br />
    - 利用<code> Theos </code>编译 removePIE<br />
    - 改编一个 Mac 版的 MyRemovePIE</p>

<p>非越狱开发者可能不熟悉 Theos ，低学习成本的做法是第二种，那么让我们来改编一个 Mac 版的 MyRemovePIE 吧。
（懒得动手的可以直接到<a href="https://github.com/CarinaTT/MyRemovePIE">这里</a>下载 demo ）</p>

<p>创建一个 Command Line Tool 工程，</p>

<div class="figure" id="figure-21-3">
    <img src="http://ww2.sinaimg.cn/large/626e5d69gw1f7609flo73j214k0rgqac.jpg" />

    <p class="caption"><strong>图片 21.3</strong> aslr2</p>
</div>


<p>然后复制 <a href="https://github.com/peterfillmore/removePIE/blob/master/removePIE.c">removePIE.c</a>  代码到 <code>main.c</code> 中，并且修改第 43 行：
    <code>if(currentHeader.magic == MH_MAGIC){ //little endian</code></p>

<p>添加 iOS7 的判断条件:
    <code>if(currentHeader.magic == MH_MAGIC || currentHeader.magic == 0xbebafeca ){ //little endian</code></p>

<p>编译后生成可执行文件 MyRemovePIE .</p>

<p>利用我们编译生成的 MyRemovePIE 来处理应用程序：</p>

<p><code>./MyRemovePIE Portal</code></p>

<div class="figure" id="figure-21-4">
    <img src="http://ww1.sinaimg.cn/large/626e5d69gw1f76079jd97j20p409iad1.jpg" />

    <p class="caption"><strong>图片 21.4</strong> aslr3</p>
</div>


<p>这样以后支付宝 Portal 再被启动执行就不会具有 ASLR 特性了</p>

<div class="figure" id="figure-21-5">
    <img src="http://ww2.sinaimg.cn/large/626e5d69gw1f7609ztn5kj215y04egnk.jpg" />

    <p class="caption"><strong>图片 21.5</strong> aslr4</p>
</div>


<p>如何验证一下结果呢？</p>

<p>把处理过的 Portal 二进制拷贝回 iPhone ，启动支付宝钱包应用，然后 gdb 该进程，利用<code> info sh </code>命令查看偏移：</p>

<div class="figure" id="figure-21-6">
    <img src="http://ww4.sinaimg.cn/large/626e5d69gw1f760anz667j21kw066gri.jpg" />

    <p class="caption"><strong>图片 21.6</strong> aslr5</p>
</div>


<p>偏移量为 0 ，嗯，这下就好了。一些手动处理的过程可以升级为自动了～ <div class="figure" id="figure-21-7">
    <img src="http://ww4.sinaimg.cn/large/626e5d69gw1f760b57h2fj202j02ka9v.jpg" />

    <p class="caption"><strong>图片 21.7</strong> aslr6</p>
</div>




<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>
</p></div></div>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/fei-chu-ying-yong-cheng-xu-de-aslrte-xing/#disqus_thread">Comments</a></div>
	
</div>
</article>

<nav id="pagenavi">
    
        
            <a href="/Blog/" class="prev">Prev</a>
        
    
    
        <a href="/Blog/blog/page/3/" class="next">Next</a>
    
    <div class="center"><a href="/Blog/blog/archives">Blog Archives</a></div>
</nav>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2016

    Rick

</footer>
	<script src="/Blog/javascripts/slash.js"></script>
<script src="/Blog/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'ITMonkeyLife';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-52658428-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
