
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>IT Monkey Life</title>
	<meta name="author" content="Rick">

	
	<meta name="description" content="16 使用 introspy 追踪分析应用程序 如果你已阅读了《 iOS 安全攻防》系列专栏之前的文章，一定已经对静态以及运行时分析 App 有了一定的了解。 我们可以借助的分析工具很多，工具和工具之间一般没有什么优劣比较性，完全看个人习惯什么擅长什么。 多个工具多条路， &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/Blog/atom.xml" rel="alternate" title="IT Monkey Life" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/Blog/favicon.png" rel="shortcut icon">
	<link href="/Blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/Blog/">IT Monkey Life</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/Blog/">Blog</a></li>
	<li><a href="/Blog/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/Blog/">Blog</a></li>
	<li><a href="/Blog/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:ITMonkeyLife.github.io/Blog">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/Blog/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:ITMonkeyLife.github.io/Blog">
	</form>
</nav>


</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/shi-yong-introspy-zhui-zong-fen-xi-ying-yong-cheng-xu/">
		
			使用 Introspy 追踪分析应用程序</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">16</span> <span class="title">使用 introspy 追踪分析应用程序</span></h1>
    <p>如果你已阅读了《 iOS 安全攻防》系列专栏之前的文章，一定已经对静态以及运行时分析<code> App </code>有了一定的了解。</p>

<p>我们可以借助的分析工具很多，工具和工具之间一般没有什么优劣比较性，完全看个人习惯什么擅长什么。</p>

<p>多个工具多条路，那么本文将介绍追踪分析利器<code> introspy </code>。</p>

<p>对应 iOS 系统版本，下载适用的<code> introspy </code>工具包：<a href="https://github.com/iSECPartners/Introspy-iOS/releases">introspy下载地址传送门</a></p>

<p>下载后，将其拷贝到设备中，并执行安装命令：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line"># dpkg -i com.isecpartners.introspy-v0.4-iOS_7.deb</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>重启设备：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line"># killall SpringBoard</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>到设置中，就可以查看到 instrospy 的设置选项了:</p>

<div class="figure" id="figure-16-1">
    <img src="http://ww2.sinaimg.cn/large/626e5d69jw1f75zfuzba2j208w0adjrr.jpg" />

    <p class="caption"><strong>图片 16.1</strong> instrospy1</p>
</div>


<p>在<code> Introspy-Apps </code>中选择要跟踪的<code> app </code>名称。
<code>Instrospy-Settings </code>则提供一些常规跟踪设置选项，默认是全部开启。</p>

<p>然后启动想要跟踪的应用程序，就可以直接查看 log 获取<code> Instrospy </code>为我们跟踪捕获的信息，这里以跟踪支付宝 app 为例。</p>

<p>打开支付宝 App ，选择添加银行卡，随意添加一个卡号，然后点击下一步:</p>

<div class="figure" id="figure-16-2">
    <img src="http://ww2.sinaimg.cn/large/626e5d69jw1f75zgf02jqj208w0fsjrq.jpg" />

    <p class="caption"><strong>图片 16.2</strong> instrospy2</p>
</div>


<p>支付宝 app 反馈添加失败，该卡暂不支持，Instrospy 捕获的信息也很清晰：</p>

<div class="figure" id="figure-16-3">
    <img src="http://ww4.sinaimg.cn/large/626e5d69gw1f75zm8s5qyj21bc0h4425.jpg" />

    <p class="caption"><strong>图片 16.3</strong> instrospy3</p>
</div>


<p>追踪信息被保存为一个数据库<code>introspy-com.alipay.iphoneclient.db</code>，存放在：
<code>./private/var/mobile/Applications/4763A8A5-2E1D-4DC2-8376-6CB7A8B98728/Library/introspy-com.alipay.iphoneclient.db</code></p>

<p>也可以借助<code> Introspy-Analyzer </code>在本地将该数据库解析成一个直观的 report.html 查看
<a href="https://github.com/iSECPartners/Introspy-Analyzer">Introspy-Analyzer下载地址传送门</a></p>

<p>将 <code>introspy-com.alipay.iphoneclient.db</code> 拷贝到本地，执行：
<code>python introspy.py -p ios --outdir Portal-introspy-html introspy-com.alipay.iphoneclient.db</code></p>

<p>就会生成一个 <code>Portal-introspy-html</code>  文件夹，该目录下有 <code>report.html</code> ，用浏览器打开:
<code>open report.html</code></p>

<p>就可以清晰的查看追踪信息了，主要分为<code> DataStorage</code>、<code>IPC</code>、<code>Misc</code>、<code>Network</code>、<code>Crypto</code> 六大类信息。
举个例子，选择<code> Crypto </code>可以查看支付宝 app 采取了什么加密措施，如果你看过我之前的文章，一定会一眼就认出来手势密码的：</p>

<div class="figure" id="figure-16-4">
    <img src="http://ww1.sinaimg.cn/large/626e5d69gw1f75zn5ysdnj218u1cctgb.jpg" />

    <p class="caption"><strong>图片 16.4</strong> instrospy4</p>
</div>


</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/shi-yong-introspy-zhui-zong-fen-xi-ying-yong-cheng-xu/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/shi-yong-inalyzer-fen-xi-ying-yong-cheng-xu/">
		
			使用 iNalyzer 分析应用程序</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">15</span> <span class="title">使用 iNalyzer 分析应用程序</span></h1>
    <p>好想用<code> doxygen </code>画 iOS app 的<code> class </code>继承关系。</p>

<p>有没有比 class-dump-z 更直观的分析工具？
利器<code> iNalyzer </code>隆重登场～</p>

<h3>iNalyzer 的安装</h3>

<p>在 iPhone 端：</p>

<p>1）进入<code> cydia </code>添加源 http://appsec-labs.com/cydia/</p>

<p>2）搜索<code> iNalyzer </code>并安装</p>

<h3>Doxygen 和 Graphviz 的安装</h3>

<p>在 Mac 端：<br />
<code>brew install oxygen graphviz</code></p>

<h3>解密支付宝 App</h3>

<h4>查看可解密的 App</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class=""><span class="line">cd /Applications/iNalyzer5.app  
</span><span class="line">./iNalyzer5   
</span><span class="line">
</span><span class="line">usage: ./iNalyzer5 [application name] [...]  
</span><span class="line">Applications available: Portal Tenpay</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4>解密支付宝 App</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class=""><span class="line">./iNalyzer5 Portal  
</span><span class="line">
</span><span class="line">got params /var/mobile/Applications/4763A8A5-2E1D-4DC2-8376-6CB7A8B98728/Portal.app/ Portal.app 800 iNalyzer is iNalyzing Portal...  
</span><span class="line">iNalyzer:crack_binary got /var/mobile/Applications/4763A8A5-2E1D-4DC2-8376-6CB7A8B98728/Portal.app/Portal /tmp/iNalyzer5_3f0d8773/Payload/Portal.app/Portal Dumping binary...helloooo polis?  
</span><span class="line">helloooo polis?  
</span><span class="line">iNalyzer:Creating SnapShot into ClientFiles  
</span><span class="line">iNalyzer:SnapShot Done  
</span><span class="line">iNalyzer:Population Done  
</span><span class="line">iNalyzer:Dumping Headers  
</span><span class="line">iNalyzer:Patching Headers  
</span><span class="line">/bin/sh: /bin/ls: Argument list too long  
</span><span class="line">ls: cannot access *_fixed: No such file or directory  
</span><span class="line">    /var/root/Documents/iNalyzer/支付宝钱包-v8.0.0.ipa</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>将解密后的 ipa 拷贝到本地</p>

<h3>修改 doxMe.sh 脚本</h3>

<p>解压 ipa, cd 到 <code>/支付宝钱包-v8.0.0/Payload/Doxygen</code> 下找到<code> doxMe.sh</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">#!/bin/sh  
</span><span class="line">
</span><span class="line">/Applications/Doxygen.app/Contents/Resources/doxygen dox.template &amp;&amp; open ./html/index.html</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>我们是通过<code> brew </code>安装的<code> doxygen </code>，所以修改脚本为：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">#!/bin/sh  
</span><span class="line">
</span><span class="line">doxygen dox.template &amp;&amp; open ./html/index.html</span></code></pre></td></tr></table></div></figure></notextile></div>
<h3>执行 doxMe.sh 脚本</h3>

<p><code>./doxMe.sh</code></p>

<p>完成后浏览器会自动 open 生成的<code>html</code>文件</p>

<h3>查看信息</h3>

<p>通过 index.html 我们可以直观的查看到<code> Strings analysis </code>，<code> ViewControllers </code>，<code>Classes </code>等几大类的信息。</p>

<div class="figure" id="figure-15-1">
    <img src="http://ww2.sinaimg.cn/large/626e5d69gw1f75uwh8b9kj218u126al5.jpg" />

    <p class="caption"><strong>图片 15.1</strong> inalyzer1</p>
</div>


<p>在 Classes-&gt;Class Hierarchy 可以查看到类继承图示。
支付宝 app<code> class Hierarchy </code>结果冰山一角：</p>

<div class="figure" id="figure-15-2">
    <img src="http://ww4.sinaimg.cn/large/626e5d69gw1f75uxns81yj20nm0ke0uo.jpg" />

    <p class="caption"><strong>图片 15.2</strong> inalyzer2</p>
</div>


</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/shi-yong-inalyzer-fen-xi-ying-yong-cheng-xu/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/hack-shi-zhan-zhi-fu-bao-app-shou-shi-mi-ma-xiao-yan-qi-pian/">
		
			Hack 实战——支付宝 App 手势密码校验欺骗</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">14</span> <span class="title">Hack 实战——支付宝 App 手势密码校验欺骗</span></h1>
    <p>在 <a href="/Blog/blog/2016/08/25/hackshi-zhan-tan-jiu-zhi-fu-bao-app-shou-shi-mi-ma/">iOS 安全攻防（十一）：Hack实战——探究支付宝 app 手势密码</a>中，介绍了如何利用 gdb 分析 app ，确定了支付宝 app 的手势密码格式为字符串，9 个点分别对应 123456789。在 <a href="/Blog/blog/2016/08/25/ios7-de-dong-tai-ku-zhu-ru/">iOS 安全攻防（十二）：iOS7 的动态库注入</a>中，介绍了如果利用越狱大神们为我们开辟的 iOS7 动态库注入方法。</p>

<p>本文将继续深入 hack 实战，hook 支付宝手势密码校验操作，欺骗其通过任意手势输入。</p>

<p>那么到现在为止，我们已经掌握了什么信息呢？</p>

<p>1）一个名叫<code> GestureUnlockViewController </code>的类，含有<code> gestureInputView:didFinishWithPassword:  </code>方法，来处理输入的手势</p>

<p>2）正确的手势密码通过一个名叫<code> GestureUtil </code>的类读取，方法是<code> getPassword</code></p>

<p>思路马上清晰了，我们需要做 2 步：</p>

<p>1）hook <code>getPassword </code>存下正确的密码</p>

<p>2）hook <code>gestureInputView:didFinishWithPassword: </code> 替换当前输入为正确的密码</p>

<p>一个关键点，我们是用<code> Method Swizzling </code>来 hook，那么就意味操作不能过早，因为我们要保证在取到  <code>GestureUnlockViewController </code>和<code> GestureUtil class </code>后，才能进行 imp 替换。</p>

<p>所以， 我采用<code> NSNotificationCenter </code>通知机制协助完成任务。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#import &lt;objc/runtime.h&gt;  </span>
</span><span class="line"> <span class="err">#</span><span class="n">import</span> <span class="o">&lt;</span><span class="n">UIKit</span><span class="o">/</span><span class="n">UIKit</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="n">IMP</span> <span class="n">ori_getPasswd_IMP</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class="line"><span class="n">IMP</span> <span class="n">ori_gesture_IMP</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="k">@interface</span> <span class="nc">NSObject</span> <span class="nl">(HackPortal)</span>
</span><span class="line">
</span><span class="line"><span class="k">@end</span>
</span><span class="line">
</span><span class="line"><span class="k">@implementation</span> <span class="nc">NSObject</span> <span class="nl">(HackPortal)</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">getPassword</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">NSString</span> <span class="o">*</span><span class="n">passwd</span> <span class="o">=</span> <span class="n">ori_getPasswd_IMP</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">getPassword</span><span class="p">));</span>
</span><span class="line">    <span class="k">return</span> <span class="n">passwd</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">gestureInputView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">didFinishWithPassword:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">password</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">password</span> <span class="o">=</span> <span class="n">ori_getPasswd_IMP</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">getPassword</span><span class="p">));</span>
</span><span class="line">    <span class="n">ori_gesture_IMP</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">gestureInputView:didFinishWithPassword:</span><span class="p">),</span> <span class="n">view</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">@end</span>
</span><span class="line">
</span><span class="line"><span class="k">@implementation</span> <span class="nc">PortalListener</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">init</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">];</span>
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span><span class="nl">addObserver:</span><span class="n">self</span>
</span><span class="line">                                                <span class="nl">selector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">appLaunched:</span><span class="p">)</span>
</span><span class="line">                                                    <span class="nl">name:</span><span class="n">UIApplicationDidBecomeActiveNotification</span>
</span><span class="line">                                                  <span class="nl">object:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">appLaunched:</span><span class="p">(</span><span class="n">NSNotification</span> <span class="o">*</span><span class="p">)</span><span class="nv">notification</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">Class</span> <span class="n">class_GestureUtil</span> <span class="o">=</span> <span class="n">NSClassFromString</span><span class="p">(</span><span class="s">@&quot;GestureUtil&quot;</span><span class="p">);</span>
</span><span class="line">    <span class="n">Class</span> <span class="n">class_PortalListener</span> <span class="o">=</span> <span class="n">NSClassFromString</span><span class="p">(</span><span class="s">@&quot;PortalListener&quot;</span><span class="p">);</span>
</span><span class="line">    <span class="n">Method</span> <span class="n">ori_Method</span> <span class="o">=</span> <span class="n">class_getClassMethod</span><span class="p">(</span><span class="n">class_GestureUtil</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">getPassword</span><span class="p">));</span>
</span><span class="line">    <span class="n">ori_getPasswd_IMP</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">ori_Method</span><span class="p">);</span>
</span><span class="line">    <span class="n">Method</span> <span class="n">my_Method</span> <span class="o">=</span> <span class="n">class_getClassMethod</span><span class="p">(</span><span class="n">class_PortalListener</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">getPassword</span><span class="p">));</span>
</span><span class="line">    <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">ori_Method</span><span class="p">,</span> <span class="n">my_Method</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="n">Class</span> <span class="n">class_Gesture</span> <span class="o">=</span> <span class="n">NSClassFromString</span><span class="p">(</span><span class="s">@&quot;GestureUnlockViewController&quot;</span><span class="p">);</span>
</span><span class="line">    <span class="n">Method</span> <span class="n">ori_Method1</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">class_Gesture</span><span class="p">,</span>
</span><span class="line">                                                 <span class="k">@selector</span><span class="p">(</span><span class="nl">gestureInputView:didFinishWithPassword:</span><span class="p">));</span>
</span><span class="line">    <span class="n">ori_gesture_IMP</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">ori_Method1</span><span class="p">);</span>
</span><span class="line">    <span class="n">Method</span> <span class="n">my_Method1</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">class_PortalListener</span><span class="p">,</span>
</span><span class="line">                                                <span class="k">@selector</span><span class="p">(</span><span class="nl">gestureInputView:didFinishWithPassword:</span><span class="p">));</span>
</span><span class="line">    <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">ori_Method1</span><span class="p">,</span> <span class="n">my_Method1</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">dealloc</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span><span class="nl">removeObserver:</span><span class="n">self</span><span class="p">];</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">@end</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="n">initialize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">static</span> <span class="n">PortalListener</span> <span class="o">*</span><span class="n">entrance</span><span class="p">;</span>
</span><span class="line">    <span class="n">entrance</span> <span class="o">=</span> <span class="p">[[</span><span class="n">PortalListener</span> <span class="n">alloc</span><span class="p">]</span><span class="n">init</span><span class="p">];</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>OK！编译好动态库，塞进 iPhone 试试效果吧～</p>

<p>不管我们输入什么手势，都会被替换为正确的密码去给<code>     gestureInputView:didFinishWithPassword: </code>验证，然后顺利解锁。</p>

<p>这意味着什么呢？</p>

<p>意味着，我们可以通过正规的渠道让用户下载这个动态库，然后悄悄放进越狱的 iPhone 的 <code>/Library/MobileSubstrate/DynamicLibraries/</code> 目录下……然后……然后去给妹纸帅锅变魔术吧：“你看，我和你多心有灵犀，你改什么密码我都猜的到!”</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/hack-shi-zhan-zhi-fu-bao-app-shou-shi-mi-ma-xiao-yan-qi-pian/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/shu-ju-ca-chu/">
		
			数据擦除</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">13</span> <span class="title">数据擦除</span></h1>
    <p>对于敏感数据，我们不希望长时间放在内存中，而希望使用完后立即就被释放掉。</p>

<p>但是不管是<code> ARC </code>还是<code> MRC</code>，自动释放池也有轮循工作周期，我们都无法控制内存数据被擦除的准确时间，让 hackers 们有机可乘。
本文介绍一个小技巧——及时数据擦除。</p>

<p>假如一个 View Controller A的一个数据被绑在一个 property 上，</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">@interface</span> <span class="nc">WipingMemoryViewController</span> : <span class="nc">UIViewController</span>
</span><span class="line">
</span><span class="line"><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span><span class="n">copy</span><span class="p">)</span> <span class="n">NSString</span><span class="o">*</span> <span class="n">text</span><span class="p">;</span>
</span><span class="line"><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>当 A push 到另外一个 View Controller B 时，该数据还是有可能被读到的</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="n">WipingMemoryViewController</span> <span class="o">*</span><span class="n">lastController</span> <span class="o">=</span> <span class="p">(</span><span class="n">WipingMemoryViewController</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="p">.</span><span class="n">navigationController</span><span class="p">.</span><span class="n">viewControllers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class="line"><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;text = %@&quot;</span><span class="p">,</span><span class="n">lastController</span><span class="p">.</span><span class="n">text</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>于是，“用后即擦”变得十分必要：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="n">_text</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span><span class="nl">initWithFormat:</span><span class="s">@&quot;information&quot;</span><span class="p">];</span>
</span><span class="line"><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Origal string = %@&quot;</span><span class="p">,</span><span class="n">_text</span><span class="p">);</span>
</span><span class="line"><span class="c1">//do something...  </span>
</span><span class="line"><span class="n">charchar</span> <span class="o">*</span><span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="n">charchar</span> <span class="o">*</span><span class="p">)</span><span class="n">CFStringGetCStringPtr</span><span class="p">((</span><span class="n">CFStringRef</span><span class="p">)</span><span class="n">_text</span><span class="p">,</span> <span class="n">CFStringGetSystemEncoding</span><span class="p">());</span>
</span><span class="line"><span class="n">memset</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">_text</span> <span class="n">length</span><span class="p">]);</span>
</span><span class="line"><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;final text = %@&quot;</span><span class="p">,</span><span class="n">_text</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Log 输出如下：</p>

<div class="code code">
<pre class="code">WipingMemory[2518:70b] Origal string = information  
WipingMemory[2518:70b] final text =</pre>
</div>

<p>可以看到，我们想要保护的数据，被有效的擦除了。</p>

<p>还有提个醒，如果是这样</p>

<p><code>_text = @"information";</code></p>

<p>创建的字符串，是会被分配到 data 区，而是无法修改的。</p>

<p>如果有兴趣也有闲心，可以试试运行下面的代码，有彩蛋哦：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="n">_text</span> <span class="o">=</span> <span class="s">@&quot;information&quot;</span><span class="p">;</span>
</span><span class="line"><span class="n">memset</span><span class="p">((</span><span class="n">__bridge</span> <span class="n">voidvoid</span> <span class="o">*</span><span class="p">)(</span><span class="n">_text</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_text</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class="line"><span class="n">NSString</span> <span class="o">*</span><span class="n">myString</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span><span class="nl">initWithFormat:</span><span class="s">@&quot;information&quot;</span><span class="p">];</span>
</span><span class="line"><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Origal text : %@ </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">myString</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>编译器把两个 information 的省略到一个地址了～</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/shu-ju-ca-chu/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/ios7-de-dong-tai-ku-zhu-ru/">
		
			iOS7 的动态库注入</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">12</span> <span class="title">iOS7 的动态库注入</span></h1>
    <p>iOS 系统不断升级，结构不断调整，所以我们可以利用的动态库注入方法也根据系统版本的不同而不同。</p>

<p>在此之前，我们可以利用环境变量 <code>DYLD_INSERT_LIBRARY</code> 来添加动态库，iOS7 被成功越狱后，我们需要自己去探索实践 iOS7 动态库注入的方式。</p>

<p>本文将在 iOS7.0.4 环境下，以 hook 支付宝 app 程序中 <code> ALPLauncherController </code>的视图加载方法为例，介绍在 iOS7 下，如何实现动态库注入攻击。</p>

<h3>相关工具位置信息</h3>

<p>先总结罗列一下相关编译、链接工具的位置路径信息，在各位自行下载的 iOS SDK中</p>

<div class="code code">
<pre class="code">clang :    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang
gcc :    /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/arm-apple-darwin10-llvm-gcc-4.2
ld :   /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/ld
                /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ld
sdk  :   /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS7.0.sdk/</pre>
</div>

<h3>动态库源程序</h3>

<p>我们编写一个 hook 支付宝 app 程序中 ALPLauncherController  的 viewDidLoad 方法，具体方法是利用 Method Swizzling 。</p>

<p>不熟悉 Method Swizzling 的话，可以参看我的这篇文章：<a href="/Blog/blog/2016/08/26/method-swizzling/">Method Swizzling</a></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#import &lt;UIKit/UIKit.h&gt;  </span>
</span><span class="line"> <span class="err">#</span><span class="n">import</span> <span class="o">&lt;</span><span class="n">objc</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">@implementation</span> <span class="nc">UIViewController</span> <span class="nl">(HookPortal)</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">myViewDidLoad</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;----------------------- myViewDidLoad ----------------------&quot;</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">@end</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="n">initialize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;======================= initialize ========================&quot;</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="n">Class</span> <span class="n">class</span> <span class="o">=</span> <span class="n">objc_getClass</span><span class="p">(</span><span class="s">&quot;ALPLauncherController&quot;</span><span class="p">);</span>
</span><span class="line">    <span class="n">Method</span> <span class="n">ori_Method</span> <span class="o">=</span>  <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">viewDidLoad</span><span class="p">));</span>
</span><span class="line">    <span class="n">Method</span> <span class="n">my_Method</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">myViewDidLoad</span><span class="p">));</span>
</span><span class="line">    <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">ori_Method</span><span class="p">,</span> <span class="n">my_Method</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>编译 dylib</h3>

<p>我们可以利用 xcode 直接帮忙编译 .o，或者自己手动使用 clang 编译，然后手动 ld ：</p>

<div class="code code">
<pre class="code">ld -dylib -lsystem -lobjc  -syslibroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS7.0.sdk/ -o libwq.dylib xxx.o</pre>
</div>

<h3>安置、验证 dylib</h3>

<p>将编译好的 libwq.dylib 拷贝到 iPhone 文件系统中 <code>/Library/MobileSubstrate/DynamicLibraries/</code> 下</p>

<p>如果不放心库是否能正常工作，可以加一步验证操作，写一个 demo 尝试打开自己的库：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="n">voidvoid</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">dlopen</span><span class="p">(</span><span class="s">&quot;/Library/MobileSubstrate/DynamicLibraries/libwq.dylib&quot;</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
</span><span class="line"><span class="n">handle</span> <span class="o">=</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;myViewDidLoad&quot;</span><span class="p">);</span>
</span><span class="line"><span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;++++&quot;</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class="line">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;----&quot;</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>运行检验效果</h3>

<p>到了验证效果的时候，重启设备后者执行：
<code>killall SpringBoard</code></p>

<p>启动支付宝 app，然后观察 log 信息：</p>

<div class="code code">
<pre class="code">Portal[3631] &lt;Notice&gt;: MS:Notice: Injecting: com.alipay.iphoneclient `[Portal] (847.21)`  
Portal[3631] &lt;Notice&gt;: MS:Notice: Loading: /Library/MobileSubstrate/DynamicLibraries/libwq.dylib  
Portal[3631] &lt;Warning&gt;: ======================= initialize ========================  
Portal[3631] &lt;Warning&gt;: ----------------------- myViewDidLoad ----------------------</pre>
</div>

<p>证明我们的动态库已经被加载， 我们的 Hook 也成功了。
剩下的就要自己去思考了，除了加句无聊的 Log，我们还可以做点什么呢？</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/ios7-de-dong-tai-ku-zhu-ru/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/hackshi-zhan-tan-jiu-zhi-fu-bao-app-shou-shi-mi-ma/">
		
			Hack实战——探究支付宝 App 手势密码</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">11</span> <span class="title">Hack 实战——探究支付宝 App 手势密码</span></h1>
    <p>在之前的 <a href="/Blog/blog/2016/08/25/hack-shi-zhan-jie-chu-zhi-fu-bao-shou-shi-jie-suo-ci-shu-xian-zhi/">iOS安全攻防（七）：Hack实战——解除支付宝app手势解锁错误次数限制</a>中，留了一个问题，就是如何破解手势密码。</p>

<p>方法不唯一，本文介绍如何利用 gdb 分析破解 App 。</p>

<p>当没有程序源代码的情况下，我们如何利用 gdb 呢？</p>

<p>为了确定应该如何设置断点，不得不反汇编程序来作为参考了。</p>

<p>在前面的文章提到过，支付宝 app 的手势密码校验处理非常严谨，没有抛出 BOOL 判断的方法让我们可以直接修改返回值跳过验证，而是将全部操作封在了</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">gestureInputView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">didFinishWithPassword:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">password</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>于是，我反汇编了支付宝 app ，找到手势密码解锁的相关代码片段：</p>

<div class="figure" id="figure-11-1">
    <img src="http://ww2.sinaimg.cn/large/626e5d69gw1f75unaa1pzj20l90jyjw5.jpg" />

    <p class="caption"><strong>图片 11.1</strong> guesture-password</p>
</div>


<p>红色箭头标注的地方，让人欣喜，这将是我们断点位置的最好选择。</p>

<p>首先，查看一下相关程序段符号表：</p>

<p><code>nm Portal | grep -i gestureinputview</code></p>

<p>得到结果：</p>

<p>nm Portal | grep -i getpassword</p>

<p>得到结果：</p>

<div class="figure" id="figure-11-2">
    <img src="http://ww2.sinaimg.cn/large/626e5d69gw1f75unyvcgaj20fg04hwg4.jpg" />

    <p class="caption"><strong>图片 11.2</strong> guesture-password2</p>
</div>


<p>确定了了关键函数的输出符号。</p>

<p>启动支付宝 app ，并 gdb 该进程：
<code>gdb -q -p 671</code></p>

<p>在上述两个函数位置设置断点：
<div class="figure" id="figure-11-3">
    <img src="http://ww4.sinaimg.cn/large/626e5d69gw1f75up0u087j20hp02bgmb.jpg" />

    <p class="caption"><strong>图片 11.3</strong> guesture-password3</p>
</div>


<p>可以通过 info breakpoints 查看断点：
<div class="figure" id="figure-11-4">
    <img src="http://ww3.sinaimg.cn/large/626e5d69gw1f75uppyzbzj20pj034my3.jpg" />

    <p class="caption"><strong>图片 11.4</strong> guesture-password4</p>
</div>


<p>continue 到 getPassword 位置，打印函数栈：
<div class="figure" id="figure-11-5">
    <img src="http://ww4.sinaimg.cn/large/626e5d69gw1f75uq86ydyj20kn09en0w.jpg" />

    <p class="caption"><strong>图片 11.5</strong> guesture-password5</p>
</div>


<p>我们可以确定了 getPassword 的返回地址是 0x00becb36 ,  对该地址加断点：</p>

<p><code>b * 0xbecb36</code></p>

<p>然后继续 continue ，程序将卡在上面的断点上。</p>

<p>从上面的反汇编代码，我们可以知道，用户输入的密码为存在 r8 上，原始密码为存在 r0 上，我们直接打印出这两个寄存器的值：</p>

<div class="figure" id="figure-11-6">
    <img src="http://ww1.sinaimg.cn/large/626e5d69gw1f75ur9u2hlj20mm07pmxu.jpg" />

    <p class="caption"><strong>图片 11.6</strong> guesture-password6</p>
</div>


<p>正确密码是个 “Z” 手势图画，而当前输入为 “一” 手势图画。
可以得出结论，支付宝 app 的手势密码和大多数 app 一样，手势密码格式是字符串，9 个点分别对应字符 123456789 。</p>



<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>
</p></p></p></div></div>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/hackshi-zhan-tan-jiu-zhi-fu-bao-app-shou-shi-mi-ma/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/er-jin-zhi-he-zi-yuan-wen-jian-zi-jian/">
		
			二进制和资源文件自检</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">10</span> <span class="title">二进制和资源文件自检</span></h1>
    <p>我们把自己的程序发布到 app store，但是不能保证每一个用户都是从 app store 下载官方 app，也不能保证每一个用户都不越狱。
换句话说，我们无法保证程序运行环境在 MAC 管控策略下就绝对的安全。
所以，在有些情况下，尤其是和钱有关系的 app ，我们有必要在和服务器通信时，让服务器知道客户端到底是不是官方正版的 app 。</p>

<p>何以判断自己是不是正版 app 呢？ hackers 们破解你的 app ，无非就 2 个地方可以动，1 个是二进制，1 个是资源文件。</p>

<p>二进制都重新编译过了自然肯定是盗版……</p>

<p>有些低级的 hackers 喜欢修改人家的资源文件然后贴上自己的广告，或者给用户错误的指引……修改资源文件是不需要重新编译二进制的。</p>

<p>因此，我们有必要在敏感的请求报文中，增加正版应用的二进制和资源文件的标识，让服务器知道，此请求是否来自正版的未经修改的 app 。
在沙盒中，我们可以读到自己程序的二进制，也可以读到资源文件签名文件，这两个文件都不算大，我们可以对其取 md5 值然后以某种组合算法得到一个标记字符串，然后发给服务器。</p>

<p>我封装了相关文件的读取地址</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">@implementation</span> <span class="nc">WQPathUtilities</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">directory:</span><span class="p">(</span><span class="n">NSSearchPathDirectory</span><span class="p">)</span><span class="nv">dir</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">NSArray</span> <span class="o">*</span><span class="n">paths</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="n">YES</span><span class="p">);</span>
</span><span class="line">    <span class="n">NSString</span> <span class="o">*</span><span class="n">dirStr</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span> <span class="nl">objectAtIndex:</span><span class="mi">0</span><span class="p">];</span>
</span><span class="line">    <span class="k">return</span> <span class="n">dirStr</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">documentsDirectory</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="p">[</span><span class="n">WQPathUtilities</span> <span class="nl">directory:</span><span class="n">NSDocumentDirectory</span><span class="p">];</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">cachesDirectory</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="p">[</span><span class="n">WQPathUtilities</span> <span class="nl">directory:</span><span class="n">NSCachesDirectory</span><span class="p">];</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">tmpDirectory</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">NSTemporaryDirectory</span><span class="p">();</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">homeDirectory</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">NSHomeDirectory</span><span class="p">();</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">codeResourcesPath</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">NSString</span> <span class="o">*</span><span class="n">excutableName</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="n">infoDictionary</span><span class="p">][</span><span class="s">@&quot;CFBundleExecutable&quot;</span><span class="p">];</span>
</span><span class="line">    <span class="n">NSString</span> <span class="o">*</span><span class="n">tmpPath</span> <span class="o">=</span> <span class="p">[[</span><span class="n">WQPathUtilities</span> <span class="n">documentsDirectory</span><span class="p">]</span> <span class="n">stringByDeletingLastPathComponent</span><span class="p">];</span>
</span><span class="line">    <span class="n">NSString</span> <span class="o">*</span><span class="n">appPath</span> <span class="o">=</span> <span class="p">[[</span><span class="n">tmpPath</span> <span class="nl">stringByAppendingPathComponent:</span><span class="n">excutableName</span><span class="p">]</span>
</span><span class="line">                         <span class="nl">stringByAppendingPathExtension:</span><span class="s">@&quot;app&quot;</span><span class="p">];</span>
</span><span class="line">    <span class="n">NSString</span> <span class="o">*</span><span class="n">sigPath</span> <span class="o">=</span> <span class="p">[[</span><span class="n">appPath</span> <span class="nl">stringByAppendingPathComponent:</span><span class="s">@&quot;_CodeSignature&quot;</span><span class="p">]</span>
</span><span class="line">                         <span class="nl">stringByAppendingPathComponent:</span><span class="s">@&quot;CodeResources&quot;</span><span class="p">];</span>
</span><span class="line">    <span class="k">return</span> <span class="n">sigPath</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">binaryPath</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">NSString</span> <span class="o">*</span><span class="n">excutableName</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="n">infoDictionary</span><span class="p">][</span><span class="s">@&quot;CFBundleExecutable&quot;</span><span class="p">];</span>
</span><span class="line">    <span class="n">NSString</span> <span class="o">*</span><span class="n">tmpPath</span> <span class="o">=</span> <span class="p">[[</span><span class="n">WQPathUtilities</span> <span class="n">documentsDirectory</span><span class="p">]</span> <span class="n">stringByDeletingLastPathComponent</span><span class="p">];</span>
</span><span class="line">    <span class="n">NSString</span> <span class="o">*</span><span class="n">appPath</span> <span class="o">=</span> <span class="p">[[</span><span class="n">tmpPath</span> <span class="nl">stringByAppendingPathComponent:</span><span class="n">excutableName</span><span class="p">]</span>
</span><span class="line">                         <span class="nl">stringByAppendingPathExtension:</span><span class="s">@&quot;app&quot;</span><span class="p">];</span>
</span><span class="line">    <span class="n">NSString</span> <span class="o">*</span><span class="n">binaryPath</span> <span class="o">=</span> <span class="p">[</span><span class="n">appPath</span> <span class="nl">stringByAppendingPathComponent:</span><span class="n">excutableName</span><span class="p">];</span>
</span><span class="line">    <span class="k">return</span> <span class="n">binaryPath</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4>md5方法：</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#import &quot;CommonCrypto/CommonDigest.h&quot;  </span>
</span><span class="line">
</span><span class="line"><span class="k">+</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">md5WithString:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">string</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">const</span> <span class="n">charchar</span> <span class="o">*</span><span class="n">cStr</span> <span class="o">=</span> <span class="p">[</span><span class="n">string</span> <span class="n">UTF8String</span><span class="p">];</span>
</span><span class="line">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">result</span><span class="p">[</span><span class="n">CC_MD5_DIGEST_LENGTH</span><span class="p">];</span>
</span><span class="line">    <span class="n">CC_MD5</span><span class="p">(</span><span class="n">cStr</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cStr</span><span class="p">),</span> <span class="n">result</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="p">[[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X&quot;</span><span class="p">,</span>
</span><span class="line">             <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span class="line">             <span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
</span><span class="line">             <span class="n">result</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
</span><span class="line">             <span class="n">result</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
</span><span class="line">             <span class="p">]</span> <span class="n">lowercaseString</span><span class="p">];</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这样做就 100% 安全了吗？<br />
答案是：不……<br />
所谓魔高一尺，道高一丈，不过也能阻止一些低级的 hack 手段了～</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/er-jin-zhi-he-zi-yuan-wen-jian-zi-jian/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/shi-yong-keychain-dumper-dao-chu-keychain-shu-ju/">
		
			使用Keychain-Dumper 导出 Keychain 数据</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">9</span> <span class="title">使用 Keychain-Dumper 导出 keychain 数据</span></h1>
    <p>iOS 系统及第三方应用都会使用 Keychain 来作为数据持久化存储媒介，或者应用间数据共享的渠道。</p>

<p>所以 Keychain 数据库是 hacker 们最关注的数据源头之一。
不知道是算幸运还是不幸，导出 Keychain 数据库数据的工具早已非常完善，下载地址：<a href="https://github.com/ptoomey3/Keychain-Dumper">Keychain-Dumper传送门</a></p>

<h4>操作步骤极其简单：</h4>

<p>1）赋予 Keychain 数据库可读权限</p>

<div class="code code">
<pre class="code">Primer:~ root# cd /private/var/Keychains/
&nbsp;
Primer:/private/var/Keychains root# ls  
TrustStore.sqlite3  accountStatus.plist  caissuercache.sqlite3  keychain-2.db  keychain-2.db-shm  keychain-2.db-wal  ocspcache.sqlite3  ocspcache.sqlite3-shm  ocspcache.sqlite3-wal  
&nbsp;
Primer:/private/var/Keychains root# chmod +r keychain-2.db</pre>
</div>

<p>2）使用 Keychain-Dumper 导出 Keychain</p>

<div class="code code">
<pre class="code">Primer:/private/var/Keychains root# /your_path/keychain_dumper &gt; keychain-export.txt</pre>
</div>

<p>然后拷贝到本地查看，到底 iOS 系统和第三方应用都存放了哪些信息，就一览无余了。</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/shi-yong-keychain-dumper-dao-chu-keychain-shu-ju/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/jian-pan-huan-cun-yu-an-quan-jian-pan/">
		
			键盘缓存与安全键盘</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">8</span> <span class="title">键盘缓存与安全键盘</span></h1>
    <p>大部分中文应用弹出的默认键盘是简体中文输入法键盘，在输入用户名和密码的时候，如果使用简体中文输入法键盘，输入英文字符和数字字符的用户名和密码时，会自动启动系统输入法自动更正提示，然后用户的输入记录会被缓存下来。</p>

<p>系统键盘缓存最方便拿到的就是利用系统输入法自动更正的字符串输入记录。
缓存文件的地址是：<br />
<code>/private/var/mobile/Library/Keyboard/dynamic-text.dat</code></p>

<p>导出该缓存文件，查看内容，欣喜的发现一切输入记录都是明文存储的。因为系统不会把所有的用户输入记录都当作密码等敏感信息来处理。
一般情况下，一个常规 iPhone 用户的 dynamic-text.dat 文件，高频率出现的字符串就是用户名和密码。</p>

<p>所以，一般银行客户端 app 输入密码时都不使用系统键盘，而使用自己定制的键盘，原因主要有 2 个：</p>

<p>1）避免第三方读取系统键盘缓存</p>

<p>2）防止屏幕录制 （自己定制的键盘按键不加按下效果）</p>

<p>那么，如何实现自定义安全键盘呢？大致思路如下：</p>

<p>1）首先捕获系统键盘的弹出、收回通知<br />
2）创建一个更高级别的 window 挡住系统键盘<br />
3）需要抛出一个 id<uitextinput>textInput 的弱引用切换焦点

<p>下面给出一个简单的安全键盘模型：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
<span class="line-number">104</span>
<span class="line-number">105</span>
<span class="line-number">106</span>
<span class="line-number">107</span>
<span class="line-number">108</span>
<span class="line-number">109</span>
<span class="line-number">110</span>
<span class="line-number">111</span>
<span class="line-number">112</span>
<span class="line-number">113</span>
<span class="line-number">114</span>
<span class="line-number">115</span>
<span class="line-number">116</span>
<span class="line-number">117</span>
<span class="line-number">118</span>
<span class="line-number">119</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">@interface</span> <span class="nc">WQSafeKeyboard</span> : <span class="nc">UIWindow</span>
</span><span class="line">
</span><span class="line"><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">setter</span> <span class="o">=</span> <span class="nl">focusOnTextFiled:</span><span class="p">)</span> <span class="n">UITextField</span> <span class="o">*</span><span class="n">textFiled</span><span class="p">;</span>
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">WQSafeKeyboard</span> <span class="o">*</span><span class="p">)</span><span class="nf">deploySafeKeyboard</span><span class="p">;</span>
</span><span class="line"><span class="k">@end</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">@interface</span> <span class="nc">WQSafeKeyboard</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span><span class="n">WQInterKeyboard</span> <span class="o">*</span><span class="n">keyboard</span><span class="p">;</span>
</span><span class="line"><span class="k">@end</span>
</span><span class="line">
</span><span class="line"><span class="k">@implementation</span> <span class="nc">WQSafeKeyboard</span>
</span><span class="line">
</span><span class="line"><span class="k">+</span> <span class="p">(</span><span class="n">WQSafeKeyboard</span> <span class="o">*</span><span class="p">)</span><span class="nf">deploySafeKeyboard</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">WQSafeKeyboard</span> <span class="o">*</span><span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">WQSafeKeyboard</span> <span class="n">alloc</span><span class="p">]</span><span class="n">init</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">kb</span> <span class="n">addObserver</span><span class="p">];</span>
</span><span class="line">    <span class="k">return</span> <span class="n">kb</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="nf">init</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
</span><span class="line">        <span class="n">self</span><span class="p">.</span><span class="n">windowLevel</span> <span class="o">=</span> <span class="n">UIWindowLevelAlert</span><span class="p">;</span>
</span><span class="line">        <span class="n">self</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectZero</span><span class="p">;</span>
</span><span class="line">        <span class="n">self</span><span class="p">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">keyboard</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">dealloc</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">removeObserver:</span><span class="n">self</span><span class="p">];</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="n">WQInterKeyboard</span> <span class="o">*</span><span class="p">)</span><span class="nf">keyboard</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_keyboard</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="n">_keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">WQInterKeyboard</span> <span class="n">alloc</span><span class="p">]</span><span class="n">init</span><span class="p">];</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">_keyboard</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">focusOnTextFiled:</span><span class="p">(</span><span class="n">UITextField</span> <span class="o">*</span><span class="p">)</span><span class="nv">textFiled</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">_textFiled</span> <span class="o">=</span> <span class="n">textFiled</span><span class="p">;</span>
</span><span class="line">    <span class="n">self</span><span class="p">.</span><span class="n">keyboard</span><span class="p">.</span><span class="n">textField</span> <span class="o">=</span> <span class="n">_textFiled</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addObserver</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span><span class="nl">addObserver:</span><span class="n">self</span>
</span><span class="line">                                            <span class="nl">selector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">keyboardWillShow:</span><span class="p">)</span>
</span><span class="line">                                                <span class="nl">name:</span><span class="n">UIKeyboardWillShowNotification</span>
</span><span class="line">                                              <span class="nl">object:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class="line">    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span><span class="nl">addObserver:</span><span class="n">self</span>
</span><span class="line">                                            <span class="nl">selector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">keyboardWillHide:</span><span class="p">)</span>
</span><span class="line">                                                <span class="nl">name:</span><span class="n">UIKeyboardWillHideNotification</span>
</span><span class="line">                                              <span class="nl">object:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">keyboardWillShow:</span><span class="p">(</span><span class="n">NSNotification</span> <span class="o">*</span><span class="p">)</span><span class="nv">notification</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textFiled</span> <span class="n">isFirstResponder</span><span class="p">])</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="p">[</span><span class="n">self</span> <span class="nl">keyboardAnimationWithNotification:</span><span class="n">notification</span><span class="p">];</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">keyboardWillHide:</span><span class="p">(</span><span class="n">NSNotification</span> <span class="o">*</span><span class="p">)</span><span class="nv">notification</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textFiled</span> <span class="n">isFirstResponder</span><span class="p">])</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="p">[</span><span class="n">self</span> <span class="nl">keyboardAnimationWithNotification:</span><span class="n">notification</span><span class="p">];</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">keyboardAnimationWithNotification:</span><span class="p">(</span><span class="n">NSNotification</span> <span class="o">*</span><span class="p">)</span><span class="nv">notification</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="p">[</span><span class="n">self</span> <span class="n">makeKeyAndVisible</span><span class="p">];</span>
</span><span class="line">    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">userInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">notification</span> <span class="n">userInfo</span><span class="p">];</span>
</span><span class="line">    <span class="n">CGRect</span> <span class="n">kbFrame_end</span><span class="p">,</span><span class="n">kbFrame_begin</span><span class="p">;</span>
</span><span class="line">    <span class="n">NSTimeInterval</span> <span class="n">animationDuration</span><span class="p">;</span>
</span><span class="line">    <span class="n">UIViewAnimationCurve</span> <span class="n">animationCurve</span><span class="p">;</span>
</span><span class="line">    <span class="p">[</span><span class="n">userInfo</span><span class="p">[</span><span class="n">UIKeyboardFrameEndUserInfoKey</span><span class="p">]</span> <span class="nl">getValue:</span><span class="o">&amp;</span><span class="n">kbFrame_end</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">userInfo</span><span class="p">[</span><span class="n">UIKeyboardFrameBeginUserInfoKey</span><span class="p">]</span> <span class="nl">getValue:</span><span class="o">&amp;</span><span class="n">kbFrame_begin</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">userInfo</span><span class="p">[</span><span class="n">UIKeyboardAnimationCurveUserInfoKey</span><span class="p">]</span> <span class="nl">getValue:</span><span class="o">&amp;</span><span class="n">animationCurve</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">userInfo</span><span class="p">[</span><span class="n">UIKeyboardAnimationDurationUserInfoKey</span><span class="p">]</span> <span class="nl">getValue:</span><span class="o">&amp;</span><span class="n">animationDuration</span><span class="p">];</span>
</span><span class="line">
</span><span class="line">    <span class="n">self</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">resizeFrameToAdjust:</span><span class="n">kbFrame_begin</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">UIView</span> <span class="nl">animateWithDuration:</span><span class="n">animationDuration</span>
</span><span class="line">                          <span class="nl">delay:</span><span class="mi">0</span>
</span><span class="line">                        <span class="nl">options:</span><span class="p">(</span><span class="n">animationCurve</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span>
</span><span class="line">                     <span class="nl">animations:</span><span class="o">^</span><span class="p">{</span>
</span><span class="line">                         <span class="n">self</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">resizeFrameToAdjust:</span><span class="n">kbFrame_end</span><span class="p">];</span>
</span><span class="line">                     <span class="p">}</span><span class="nl">completion:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">
</span><span class="line">                     <span class="p">}];</span>
</span><span class="line">    <span class="k">if</span> <span class="p">([</span><span class="n">notification</span><span class="p">.</span><span class="n">name</span> <span class="nl">isEqualToString:</span><span class="n">UIKeyboardWillHideNotification</span><span class="p">])</span> <span class="p">{</span>
</span><span class="line">        <span class="p">[</span><span class="n">self</span> <span class="n">resignKeyWindow</span><span class="p">];</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">-</span> <span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="nf">resizeFrameToAdjust:</span><span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">frame</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">if</span> <span class="p">([[</span><span class="n">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="n">isStatusBarHidden</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">frame</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">SYSTEM_VERSION_LESS_THAN</span><span class="p">(</span><span class="s">@&quot;7.0&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class="line">        <span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
</span><span class="line">                           <span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">STATUSBAR_HEIGHT</span><span class="p">,</span>
</span><span class="line">                           <span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
</span><span class="line">                           <span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">frame</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>



<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>
</uitextinput></p></div></div>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/jian-pan-huan-cun-yu-an-quan-jian-pan/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/hack-shi-zhan-jie-chu-zhi-fu-bao-shou-shi-jie-suo-ci-shu-xian-zhi/">
		
			Hack 实战——解除支付宝手势解锁次数限制</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">7</span> <span class="title">Hack 实战——解除支付宝 App 手势解锁错误次数限制</span></h1>
    <p>之前仅仅介绍了工具的使用，本文将实践一下如何利用 cycript 结合 class-dump 结果 hack，还要牺牲一下支付宝 App 。</p>

<p>首先，老套路，取到手势解锁界面的 View Controller:</p>

<div class="code code">
<pre class="code">cy# var app = [UIApplication sharedApplication]  
@&quot;&lt;DFApplication: 0x1666c960&gt;&quot;  
cy# var keyWindow = app.keyWindow  
@&quot;&lt;UIWindow: 0x16591bd0; frame = (0 0; 320 568); gestureRecognizers = &lt;NSArray: 0x1b047000&gt;; layer = &lt;UIWindowLayer: 0x165d0650&gt;&gt;&quot;  
cy# var root = keyWindow.rootViewController  
@&quot;&lt;UINavigationController: 0x179779a0&gt;&quot;  
cy# var visible = root.visibleViewController  
@&quot;&lt;GestureUnlockViewController: 0x165de090&gt;&quot;</pre>
</div>

<p>然后，对照 class-dump-z 结果，来分析 GestureUnlockViewController 有什么利用价值 ：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">@interface</span> <span class="nc">GestureUnlockViewController</span> : <span class="nc">DTViewController</span> <span class="o">&lt;</span><span class="n">UIAlertViewDelegate</span><span class="p">,</span> <span class="n">GestureHeadImageViewDelegate</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class="line"><span class="k">@private</span>
</span><span class="line">    <span class="n">GestureHeadImageView</span><span class="o">*</span> <span class="n">_headImageView</span><span class="p">;</span>
</span><span class="line">    <span class="n">GestureTipLabel</span><span class="o">*</span> <span class="n">_tipLabel</span><span class="p">;</span>
</span><span class="line">    <span class="n">GestureInputView</span><span class="o">*</span> <span class="n">_inputView</span><span class="p">;</span>
</span><span class="line">    <span class="n">DTButton</span><span class="o">*</span> <span class="n">_forgetButton</span><span class="p">;</span>
</span><span class="line">    <span class="n">DTButton</span><span class="o">*</span> <span class="n">_changeAccountButton</span><span class="p">;</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">_retryCount</span><span class="p">;</span>
</span><span class="line">    <span class="n">UIView</span><span class="o">*</span> <span class="n">_guideView</span><span class="p">;</span>
</span><span class="line">    <span class="kt">id</span><span class="o">&lt;</span><span class="n">GestrueViewControllerDelegate</span><span class="o">&gt;</span> <span class="n">_delegate</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">__weak</span> <span class="kt">id</span><span class="o">&lt;</span><span class="n">GestrueViewControllerDelegate</span><span class="o">&gt;</span> <span class="n">delegate</span><span class="p">;</span>
</span><span class="line"><span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">).</span><span class="n">cxx_destruct</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">shouldAutorotateToInterfaceOrientation:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">interfaceOrientation</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">headClicked</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">gestureInputView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">didFinishWithPassword:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">password</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">gestureInputViewFirstEffectiveTouch:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">touch</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">alertView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">clickedButtonAtIndex:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">index</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">actionChangeAccountToLogin</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">actionResetPswBtnClick</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">resetCurrentUser</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">resetPsw</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewWillDisappear:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">view</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">notifyFaceToFacePayReceivedData:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">facePayReceivedData</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewWillAppear:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">view</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">breakFirstRun</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isFirstRun</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">guideViewClicked:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">clicked</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewWillLayoutSubviews</span><span class="p">;</span>
</span><span class="line"><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>目测 <code>_tipLabel</code> 是写账户名和提示操作的 label ，上篇文章我提到过：@private 限制不了 keyPath ，现在我们来修改一下支付宝登录页的用户名信息：</p>

<div class="code code">
<pre class="code">cy# [visible setValue:@&quot;Test By yiyaaixuexi&quot; forKeyPath:@&quot;_tipLabel.text&quot;]</pre>
</div>

<div class="figure" id="figure-7-1">
    <img src="http://ww1.sinaimg.cn/large/626e5d69gw1f75ua3yb6aj208w0fsmys.jpg" />

    <p class="caption"><strong>图片 7.1</strong> hack-practice</p>
</div>


<p>支付宝手势密码解锁有尝试次数限制，连续错 5 次就要重新登录。
我想解除重试解锁次数的限制，发现了记录解锁次数的类型是 int ，<code>int _retryCount</code> ，这一点让我很不开心，因为我无法通过 KVC 来修改其值了。</p>

<p>但是没有关系，我可以通过指针访问：</p>

<div class="code code">
<pre class="code">cy# visible-&gt;_retryCount = 0  
0</pre>
</div>

<p>这样我就能无限制的用程序暴力破解手势密码了，来计算一下有多少种可能呢？</p>

<div class="figure" id="figure-7-2">
    <img src="http://ww4.sinaimg.cn/large/626e5d69gw1f75uaz3e83j20lk01aaam.jpg" />

    <p class="caption"><strong>图片 7.2</strong> hack-practice2</p>
</div>


<p>这个数字对我来说有点大，可是对 iPhone5 的 CPU 来说就是小菜一碟了～</p>

<p>等一下，密码格式是什么呢？</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">gestureInputView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">didFinishWithPassword:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">password</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>id 类型的密码，很严谨，又给 hack 带来不少麻烦呀～
不过没关系，我们可以利用 Method Swizzling 来打出 password 到底是什么，不过呢，貌似可以再写一篇新文章去介绍了……</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/hack-shi-zhan-jie-chu-zhi-fu-bao-shou-shi-jie-suo-ci-shu-xian-zhi/#disqus_thread">Comments</a></div>
	
</div>
</article>

<nav id="pagenavi">
    
        
            <a href="/Blog/blog/page/2/" class="prev">Prev</a>
        
    
    
        <a href="/Blog/blog/page/4/" class="next">Next</a>
    
    <div class="center"><a href="/Blog/blog/archives">Blog Archives</a></div>
</nav>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2016

    Rick

</footer>
	<script src="/Blog/javascripts/slash.js"></script>
<script src="/Blog/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'ITMonkeyLife';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-52658428-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
