
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>IT Monkey Life</title>
	<meta name="author" content="Rick">

	
	<meta name="description" content="6 使用 class-dump-z 分析支付宝 App 为了了解支付宝 app 的源码结构，我们可以使用 class-dump-z 工具来分析支付宝二进制。 下载配置 class_dump_z 前往 https://code.google.com/p/networkpx/wiki/ &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/Blog/atom.xml" rel="alternate" title="IT Monkey Life" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/Blog/favicon.png" rel="shortcut icon">
	<link href="/Blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/Blog/">IT Monkey Life</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/Blog/">Blog</a></li>
	<li><a href="/Blog/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/Blog/">Blog</a></li>
	<li><a href="/Blog/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:ITMonkeyLife.github.io/Blog">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/Blog/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:ITMonkeyLife.github.io/Blog">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/shi-yong-class-dump-z-fen-xi-zhi-fu-bao/">
		
			使用class-dump-z 分析支付宝</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">6</span> <span class="title">使用 class-dump-z 分析支付宝 App</span></h1>
    <p>为了了解支付宝 app 的源码结构，我们可以使用 class-dump-z 工具来分析支付宝二进制。</p>

<h3>下载配置 <code>class_dump_z</code></h3>

<p>前往 <a href="https://code.google.com/p/networkpx/wiki/class_dump_z">https://code.google.com/p/networkpx/wiki/class_dump_z</a> ，下载 tar 包，然后解压配置到本地环境</p>

<div class="code code">
<pre class="code">$ tar -zxvf class-dump-z_0.2a.tar.gz  
$ sudo cp mac_x86/class-dump-z /usr/bin/</pre>
</div>

<h3>class_dump 支付宝 App</h3>

<div class="code code">
<pre class="code">$ class-dump-z Portal &gt; Portal-dump.txt  
&nbsp;
@protocol XXEncryptedProtocol_10764b0  
-(?)XXEncryptedMethod_d109df;  
-(?)XXEncryptedMethod_d109d3;  
-(?)XXEncryptedMethod_d109c7;  
-(?)XXEncryptedMethod_d109bf;  
-(?)XXEncryptedMethod_d109b8;  
-(?)XXEncryptedMethod_d109a4;  
-(?)XXEncryptedMethod_d10990;  
-(?)XXEncryptedMethod_d1097f;  
-(?)XXEncryptedMethod_d10970;  
-(?)XXEncryptedMethod_d10968;  
-(?)XXEncryptedMethod_d10941;  
-(?)XXEncryptedMethod_d10925;  
-(?)XXEncryptedMethod_d10914;  
-(?)XXEncryptedMethod_d1090f;  
-(?)XXEncryptedMethod_d1090a;  
-(?)XXEncryptedMethod_d10904;  
-(?)XXEncryptedMethod_d108f9;  
-(?)XXEncryptedMethod_d108f4;  
-(?)XXEncryptedMethod_d108eb;  
@optional  
-(?)XXEncryptedMethod_d109eb;  
@end</pre>
</div>

<p>查看得到的信息是加过密的，这个加密操作是苹果在部署到 app store时做的，所以我们还需要做一步解密操作。</p>

<h3>使用 Clutch 解密支付宝 App</h3>

<h4>下载 Clutch</h4>

<p>iOS7 越狱后的 Cydia 源里已经下载不到 Clutch 了，但是我们可以从网上下载好推进 iPhone</p>

<p>地址：<a href="https://github.com/KJCracks/Clutch-dl/releases">Clutch 传送门</a></p>

<h4>查看可解密的应用列表</h4>

<div class="code code">
<pre class="code">root# ./Clutch   
&nbsp;
Clutch-1.3.2  
usage: ./Clutch [flags] [application name] [...]  
Applications available: 9P_RetinaWallpapers breadtrip Chiizu CodecademyiPhone FisheyeFree food GirlsCamera IMDb InstaDaily InstaTextFree iOne ItsMe3 linecamera Moldiv MPCamera MYXJ NewsBoard Photo Blur Photo Editor PhotoWonder POCO 相机 Portal QQPicShow smashbandits Spark tripcamera Tuding_vITC_01 wantu WaterMarkCamera WeiBo Weibo</pre>
</div>

<h4>解密支付宝 App</h4>

<div class="code code">
<pre class="code">root# ./Clutch Portal  
&nbsp;
Clutch-1.3.2  
Cracking Portal...  
Creating working directory...  
Performing initial analysis...  
Performing cracking preflight...  
dumping binary: analyzing load commands  
dumping binary: obtaining ptrace handle  
dumping binary: forking to begin tracing  
dumping binary: successfully forked  
dumping binary: obtaining mach port  
dumping binary: preparing code resign  
dumping binary: preparing to dump  
dumping binary: ASLR enabled, identifying dump location dynamically  
dumping binary: performing dump  
dumping binary: patched cryptid  
dumping binary: writing new checksum  
Censoring iTunesMetadata.plist...  
Packaging IPA file...  
&nbsp;
compression level: 0  
    /var/root/Documents/Cracked/支付宝钱包-v8.0.0-(Clutch-1.3.2).ipa  
&nbsp;
elapsed time: 7473ms  
&nbsp;
Applications Cracked:   
Portal  
&nbsp;
Applications that Failed:  
&nbsp;
Total Success: 1 Total Failed: 0</pre>
</div>

<h4>导出已解密的支付宝 App</h4>

<p>从上一步骤得知，已解密的 ipa 位置为：<code>/var/root/Documents/Cracked/支付宝钱包-v8.0.0-(Clutch-1.3.2).ipa</code>
将其拷贝到本地去分析</p>

<h3><code>class_dump</code> 已解密的支付宝 App</h3>

<p>解压 .ipa 后，到支付宝钱包-<code>v8.0.0-(Clutch-1.3.2)/Payload/Portal.app</code> 目录下，class_dump 已解密的二进制文件
<code>$ class-dump-z Portal &gt; ~/Portal-classdump.txt</code></p>

<p>这回就可以得到对应的信息了：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="k">@protocol</span> <span class="nc">ALPNumPwdInputViewDelegate</span> <span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span>
</span><span class="line"><span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">onPasswordDidChange:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">onPassword</span><span class="p">;</span>
</span><span class="line"><span class="k">@end</span>
</span><span class="line">
</span><span class="line"><span class="k">@protocol</span> <span class="nc">ALPContactBaseTableViewCellDelegate</span> <span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span>
</span><span class="line"><span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">shareClicked:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">clicked</span> <span class="nl">sender:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">sender</span><span class="p">;</span>
</span><span class="line"><span class="k">@end</span>
</span><span class="line">
</span><span class="line"><span class="k">@interface</span> <span class="nc">MMPPayWayViewController</span> : <span class="nc">XXUnknownSuperclass</span> <span class="o">&lt;</span><span class="n">SubChannelSelectDelegate</span><span class="p">,</span> <span class="n">UITableViewDataSource</span><span class="p">,</span> <span class="n">UITableViewDelegate</span><span class="p">,</span> <span class="n">CellDelegate</span><span class="p">,</span> <span class="n">UIAlertViewDelegate</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class="line"><span class="k">@private</span>
</span><span class="line">    <span class="n">Item</span><span class="o">*</span> <span class="n">channelSelected</span><span class="p">;</span>
</span><span class="line">    <span class="kt">BOOL</span> <span class="n">_bCheck</span><span class="p">;</span>
</span><span class="line">    <span class="kt">BOOL</span> <span class="n">_bOpenMiniPay</span><span class="p">;</span>
</span><span class="line">    <span class="kt">BOOL</span> <span class="n">_bNeedPwd</span><span class="p">;</span>
</span><span class="line">    <span class="kt">BOOL</span> <span class="n">_bSimplePwd</span><span class="p">;</span>
</span><span class="line">    <span class="kt">BOOL</span> <span class="n">_bAutopayon</span><span class="p">;</span>
</span><span class="line">    <span class="kt">BOOL</span> <span class="n">_bHasSub</span><span class="p">;</span>
</span><span class="line">    <span class="kt">BOOL</span> <span class="n">_bFirstChannel</span><span class="p">;</span>
</span><span class="line">    <span class="kt">BOOL</span> <span class="n">_bChangeSub</span><span class="p">;</span>
</span><span class="line">    <span class="kt">BOOL</span> <span class="n">_bClickBack</span><span class="p">;</span>
</span><span class="line">    <span class="n">UITableView</span><span class="o">*</span> <span class="n">_channelListTableView</span><span class="p">;</span>
</span><span class="line">    <span class="n">NSMutableArray</span><span class="o">*</span> <span class="n">_channelListArray</span><span class="p">;</span>
</span><span class="line">    <span class="n">NSMutableArray</span><span class="o">*</span> <span class="n">_subChanneSelectedlList</span><span class="p">;</span>
</span><span class="line">    <span class="n">NSMutableArray</span><span class="o">*</span> <span class="n">_unCheckArray</span><span class="p">;</span>
</span><span class="line">    <span class="n">UIButton</span><span class="o">*</span> <span class="n">_saveButton</span><span class="p">;</span>
</span><span class="line">    <span class="n">UILabel</span><span class="o">*</span> <span class="n">_tipLabel</span><span class="p">;</span>
</span><span class="line">    <span class="n">MMPPasswordSwichView</span><span class="o">*</span> <span class="n">_payWaySwitch</span><span class="p">;</span>
</span><span class="line">    <span class="n">MMPPopupAlertView</span><span class="o">*</span> <span class="n">_alertView</span><span class="p">;</span>
</span><span class="line">    <span class="n">UIView</span><span class="o">*</span> <span class="n">_setView</span><span class="p">;</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">_originalSelectedRow</span><span class="p">;</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">_currentSelectedRow</span><span class="p">;</span>
</span><span class="line">    <span class="n">NSString</span><span class="o">*</span> <span class="n">_statusCode</span><span class="p">;</span>
</span><span class="line">    <span class="n">ChannelListModel</span><span class="o">*</span> <span class="n">_defaultChannelList</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">bClickBack</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">ChannelListModel</span><span class="o">*</span> <span class="n">defaultChannelList</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSString</span><span class="o">*</span> <span class="n">statusCode</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">int</span> <span class="n">currentSelectedRow</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">int</span> <span class="n">originalSelectedRow</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">UIView</span><span class="o">*</span> <span class="n">setView</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">MMPPopupAlertView</span><span class="o">*</span> <span class="n">alertView</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">MMPPasswordSwichView</span><span class="o">*</span> <span class="n">payWaySwitch</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">,</span> <span class="n">getter</span><span class="o">=</span><span class="n">isSubChannelChanged</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">bChangeSub</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">bFirstChannel</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">bHasSub</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">bAutopayon</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">bSimplePwd</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">bNeedPwd</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">bOpenMiniPay</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">bCheck</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">UILabel</span><span class="o">*</span> <span class="n">tipLabel</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">UIButton</span><span class="o">*</span> <span class="n">saveButton</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSMutableArray</span><span class="o">*</span> <span class="n">unCheckArray</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSMutableArray</span><span class="o">*</span> <span class="n">subChanneSelectedlList</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSMutableArray</span><span class="o">*</span> <span class="n">channelListArray</span><span class="p">;</span>
</span><span class="line"><span class="k">@property</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">UITableView</span><span class="o">*</span> <span class="n">channelListTableView</span><span class="p">;</span>
</span><span class="line"><span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">).</span><span class="n">cxx_destruct</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">subChannelDidSelected:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">subChannel</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">switchCheckButtonClicked:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">clicked</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">checkboxButtonClicked:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">clicked</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">onCellClick:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">click</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">showSubChannels</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">didSelectRowAtIndexPath:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">indexPath</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">cellForRowAtIndexPath:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">indexPath</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">numberOfRowsInSection:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">section</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">heightForRowAtIndexPath:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">indexPath</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nf">numberOfSectionsInTableView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">tableView</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setTableViewFootView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setTableViewHeaderView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">viewForHeaderInSection:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">section</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">viewForFooterInSection:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">section</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">heightForHeaderInSection:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">section</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">heightForFooterInSection:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">section</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">alertView:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">view</span> <span class="nf">clickedButtonAtIndex:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">index</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">clickSave</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">netWorkRequestWithPwd:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">pwd</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setPayWaySwitchStates:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">states</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">changePayWaySwitch:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">aSwitch</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">scrollToSelectedRow</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didReceiveMemoryWarning</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">applicationEnterBackground:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">background</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">dealloc</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">goBack</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isChannelsSetChanged</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">subChannelCode:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">code</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">subChannelDesc:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">desc</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithDefaultData:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">defaultData</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithNibName:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">nibName</span> <span class="nf">bundle:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">bundle</span><span class="p">;</span>
</span><span class="line"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">commonInit:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">init</span><span class="p">;</span>
</span><span class="line"><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>分析支付宝源码片段</h3>

<h4>使用了 @private 关键字限制成员访问权限</h4>

<p>但是实际上，在 Objective-C 编程中，使用 @private 连 Keypath 访问都拦不住的</p>

<h4>抛出了冗长的成员对象</h4>

<p>这非常有利分析程序结构</p>

<h3>进一步思考</h3>

<p>1）如何利用 class-dump 结果，结合 cycript 进行攻击呢？</p>

<p>2）class-dump-z 如此强大，有什么方法可以减少暴露的信息吗？</p>

<p>接下来的博文将针对上面的思考，继续总结～</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/shi-yong-class-dump-z-fen-xi-zhi-fu-bao/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/zu-zhi-gdb-yi-fu/">
		
			使用 Cycript 修改支付宝 App 运行时</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">5</span> <span class="title">使用 Cycript 修改支付宝 App 运行时</span></h1>
    <p>Cycript: Objective-JavaScript ，它懂 Objective-C，也懂javascript 。</p>

<p>我们能够借助 Cycript 使用 Objective-C 或者 javascript ，给某个正在运行的进程的 runtime 发送消息。</p>

<p>本文以修改支付宝 app 界面为例，介绍 Cycript 的使用方法。</p>

<h4>安装 Cycript</h4>

<p>到 Cycript 官方网站下载资源工具，然后推进已越狱的 iPhone 中，进行安装：</p>

<div class="code code">
<pre class="code">dpkg -i cycript_0.9.461_iphoneos-arm.deb  
dpkg -i libffi_1-3.0.10-5_iphoneos-arm.deb</pre>
</div>

<h4>确定支付宝进程</h4>

<p>运行支付宝 app，然后获取它的进程号：</p>

<div class="code code">
<pre class="code">Primer:/ root# ps aux | grep Portal  
&nbsp;
mobile     479   0.6  4.3   590776  44956   ??  Ss    5:14PM   0:09.58 /var/mobile/Applications/8723004E-9E54-4B37-856D-86292780E958/Portal.app/Portal  
root       497   0.0  0.0   329252    176 s000  R+    5:21PM   0:00.00 grep Portal</pre>
</div>

<h4>Cycript 钩住支付宝进程</h4>

<div class="code code">
<pre class="code">Primer:/ root# cycript -p 479  
cy#</pre>
</div>

<h4>获取当前界面的 viewController 并修改背景色</h4>

<div class="code code">
<pre class="code">cy# var app = [UIApplication sharedApplication]  
@&quot;&lt;DFApplication: 0x16530660&gt;&quot;  
&nbsp;
cy# app.delegate  
@&quot;&lt;DFClientDelegate: 0x165384d0&gt;&quot;  
&nbsp;
cy# var keyWindow = app.keyWindow  
@&quot;&lt;UIWindow: 0x1654abb0; frame = (0 0; 320 568); gestureRecognizers = &lt;NSArray: 0x1654b190&gt;; layer = &lt;UIWindowLayer: 0x1654ace0&gt;&gt;&quot;  
&nbsp;
cy# var rootController = keyWindow.rootViewController  
@&quot;&lt;DFNavigationController: 0x1654b6c0&gt;&quot;  
&nbsp;
cy# var visibleController = rootController.visibleViewController  
@&quot;&lt;ALPLauncherController: 0x166acfb0&gt;&quot;  
&nbsp;
cy# visibleController.childViewControllers  
@[&quot;&lt;HPHomeWidgetGroup: 0x166afbc0&gt;&quot;,&quot;&lt;ADWRootViewController: 0x165745c0&gt;&quot;,&quot;&lt;ALPAssetsRootViewController: 0x16577250&gt;&quot;,&quot;&lt;SWSecurityWidgetGroup: 0x166bd940&gt;&quot;]  
&nbsp;
cy# var assetsController = new Instance(0x16577250)  
@&quot;&lt;ALPAssetsRootViewController: 0x16577250&gt;&quot;  
&nbsp;
cy# assetsController.view.backgroundColor = [UIColor blueColor]  
@&quot;UIDeviceRGBColorSpace 0 0 1 1&quot;</pre>
</div>

<div class="figure" id="figure-5-1">
    <img src="http://ww3.sinaimg.cn/large/626e5d69gw1f75u2jk7lsj208w0fsjs3.jpg" />

    <p class="caption"><strong>图片 5.1</strong> cycrypt</p>
</div>


<p>当然，只是修改个背景色好没意思……</p>

<p>想修改更多信息，还得介绍一下另一个利器： class-dump 。下篇再总结～</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/zu-zhi-gdb-yi-fu/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/rezu-zhi-gdb-yi-fu/">
		
			阻止 GDB 依附</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">4</span> <span class="title">阻止 GDB 依附</span></h1>
    <p>GDB 是大多数 hackers 的首选，阻止 GDB 依附到应用的常规办法是：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#import &lt;sys/ptrace.h&gt;  </span>
</span><span class="line">
</span><span class="line"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">charchar</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line"> <span class="err">#</span><span class="n">ifndef</span> <span class="n">DEBUG</span>
</span><span class="line">    <span class="n">ptrace</span><span class="p">(</span><span class="n">PT_DENY_ATTACH</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class="line"> <span class="err">#</span><span class="n">endif</span>
</span><span class="line">    <span class="err">@</span><span class="n">autoreleasepool</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span> <span class="n">UIApplicationMain</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="nb">nil</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">([</span><span class="n">WQMainPageAppDelegate</span> <span class="n">class</span><span class="p">]));</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>但遗憾的是，iPhone 真实的运行环境是没有 sys/ptrace.h 抛出的。虽然 ptrace 方法没有被抛出, 但是不用担心，我们可以通过 dlopen 拿到它。</p>

<p>dlopen： 当 path 参数为 0 是,他会自动查找<br />
<code>$LD_LIBRARY_PATH, $DYLD_LIBRARY_PATH,  $DYLD_FALLBACK_LIBRARY_PATH</code> 和当前工作目录中的动态链接库。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#import &lt;dlfcn.h&gt;  </span>
</span><span class="line"> <span class="err">#</span><span class="n">import</span> <span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">types</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ptrace_ptr_t</span><span class="p">)(</span><span class="kt">int</span> <span class="n">_request</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">_pid</span><span class="p">,</span> <span class="n">caddr_t</span> <span class="n">_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">_data</span><span class="p">);</span>
</span><span class="line"> <span class="err">#</span><span class="k">if</span> <span class="o">!</span><span class="n">defined</span><span class="p">(</span><span class="n">PT_DENY_ATTACH</span><span class="p">)</span>
</span><span class="line"> <span class="err">#</span><span class="n">define</span> <span class="n">PT_DENY_ATTACH</span> <span class="mi">31</span>
</span><span class="line"> <span class="err">#</span><span class="n">endif</span>  <span class="c1">// !defined(PT_DENY_ATTACH)  </span>
</span><span class="line">
</span><span class="line"><span class="kt">void</span> <span class="n">disable_gdb</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="kt">void</span><span class="o">*</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">dlopen</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RTLD_GLOBAL</span> <span class="o">|</span> <span class="n">RTLD_NOW</span><span class="p">);</span>
</span><span class="line">    <span class="n">ptrace_ptr_t</span> <span class="n">ptrace_ptr</span> <span class="o">=</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;ptrace&quot;</span><span class="p">);</span>
</span><span class="line">    <span class="n">ptrace_ptr</span><span class="p">(</span><span class="n">PT_DENY_ATTACH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class="line">    <span class="n">dlclose</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">charchar</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line"> <span class="err">#</span><span class="n">ifndef</span> <span class="n">DEBUG</span>
</span><span class="line">    <span class="n">disable_gdb</span><span class="p">();</span>
</span><span class="line"> <span class="err">#</span><span class="n">endif</span>
</span><span class="line">    <span class="err">@</span><span class="n">autoreleasepool</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span> <span class="n">UIApplicationMain</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="nb">nil</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">([</span><span class="n">WQMainPageAppDelegate</span> <span class="n">class</span><span class="p">]));</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/rezu-zhi-gdb-yi-fu/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/25/revealcha-kan-app-ui/">
		
			Reveal查看APP UI</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">3</span> <span class="title">使用 Reveal 分析他人 App</span></h1>
    <h3>准备工作</h3>

<p>1）已越狱的设备，并且已安装了 OpenSSH , MobileSubstrate 等实用工具( Cydia 源里安装)</p>

<p>2）本地已安装了 Reveal</p>

<h3>操作步骤</h3>

<h4>拷贝 framework 和 dylib 到越狱机</h4>

<div class="code code">
<pre class="code">&nbsp;
scp -r /Applications/Reveal.app/Contents/SharedSupport/iOS-Libraries/Reveal.framework root@192.168.0.X:/System/Library/Frameworks
scp /Applications/Reveal.app/Contents/SharedSupport/iOS-Libraries/libReveal.dylib root@192.168.0.X:/Library/MobileSubstrate/DynamicLibraries</pre>
</div>

<h4>编辑 libReveal.plist</h4>

<p>a.可以 ssh 登录到越狱机上，并且越狱机已安装了编辑器工具例如 nano，在 /Library/MobileSubstrate/DynamicLibraries/ 下创建文件 libReveal.plist ，指定 app 的 Bundle ，可以指定多个</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">Filter</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">         <span class="n">Bundles</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;com.apple.AppStore&quot;</span><span class="p">);</span>
</span><span class="line">    <span class="p">};</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>b.也可以在本地创建好 libReveal.plist 在 scp 到指定位置 /Library/MobileSubstrate/DynamicLibraries/ 下</p>

<h4>重启越狱机</h4>

<p>a.执行 killall SpringBoard</p>

<p>b.也可以重启设备</p>

<p>然后就可以到 Reveal 看看别人的 app 怎么布局的了，苹果的appstore：</p>

<div class="figure" id="figure-3-1">
    <img src="http://ww2.sinaimg.cn/large/626e5d69gw1f75tvj27y1j21040s3woe.jpg" />

    <p class="caption"><strong>图片 3.1</strong> reveal</p>
</div>


</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/25/revealcha-kan-app-ui/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/24/lai-hu-%5B%3F%5D-zhou-nian-ji/">
		
			来沪一周年纪</a>
	</h2>
	<div class="entry-content">
		<h1>题记</h1>
<p>不知不觉，来沪一周年。特发此文，总结来沪一周年的收获。
</p>
<p>
</p>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/gan-wu/'>感悟</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/24/lai-hu-%5B%3F%5D-zhou-nian-ji/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/24/ru-he-fei-fa-qie-qu-yong-hu-xin-xi-%3F/">
		
			如何非法窃取用户信息？</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">2</span> <span class="title">后台 daemon 非法窃取用户 iTunesstore 信息</span></h1>
    <p>本人郑重声明：并不鼓励窃取用户隐私等行为，一切 hack 学习都只是为了研究如何防御。OK，进入正题。</p>

<h3>开机自启动</h3>

<p>在 <a href="/Blog/blog/2016/08/19/ioshei-ke-gong-ju/">iOS 黑客工具</a>中，介绍了如何编译自己的 C 程序并手动启动。今天介绍如何使程序变为开机自启动。</p>

<h4>首先打开 Xcode 创建一个 plist 属性文件，如下图所示：</h4>

<div class="figure" id="figure-2-1">
    <img src="http://ww3.sinaimg.cn/large/626e5d69gw1f74ojhy4upj20gg06cq46.jpg" />

    <p class="caption"><strong>图片 2.1</strong> daemon1</p>
</div>


<p>其中要注意一下通信服务名，我定为 55 。用编辑器打开，即为：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class="line"><span class="cp">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
</span><span class="line"><span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
</span><span class="line"><span class="nt">&lt;dict&gt;</span>
</span><span class="line">    <span class="nt">&lt;key&gt;</span>Program<span class="nt">&lt;/key&gt;</span>
</span><span class="line">    <span class="nt">&lt;string&gt;</span>/usr/bin/ncdemo<span class="nt">&lt;/string&gt;</span>
</span><span class="line">    <span class="nt">&lt;key&gt;</span>StandardErrorPath<span class="nt">&lt;/key&gt;</span>
</span><span class="line">    <span class="nt">&lt;string&gt;</span>/dev/null<span class="nt">&lt;/string&gt;</span>
</span><span class="line">    <span class="nt">&lt;key&gt;</span>SessionCreate<span class="nt">&lt;/key&gt;</span>
</span><span class="line">    <span class="nt">&lt;true/&gt;</span>
</span><span class="line">    <span class="nt">&lt;key&gt;</span>ProgramArguments<span class="nt">&lt;/key&gt;</span>
</span><span class="line">    <span class="nt">&lt;array&gt;</span>
</span><span class="line">        <span class="nt">&lt;string&gt;</span>/usr/bin/ncdemo<span class="nt">&lt;/string&gt;</span>
</span><span class="line">    <span class="nt">&lt;/array&gt;</span>
</span><span class="line">    <span class="nt">&lt;key&gt;</span>inetdCompatibility<span class="nt">&lt;/key&gt;</span>
</span><span class="line">    <span class="nt">&lt;dict&gt;</span>
</span><span class="line">        <span class="nt">&lt;key&gt;</span>Wait<span class="nt">&lt;/key&gt;</span>
</span><span class="line">        <span class="nt">&lt;false/&gt;</span>
</span><span class="line">    <span class="nt">&lt;/dict&gt;</span>
</span><span class="line">    <span class="nt">&lt;key&gt;</span>Sockets<span class="nt">&lt;/key&gt;</span>
</span><span class="line">    <span class="nt">&lt;dict&gt;</span>
</span><span class="line">        <span class="nt">&lt;key&gt;</span>Listeners<span class="nt">&lt;/key&gt;</span>
</span><span class="line">        <span class="nt">&lt;dict&gt;</span>
</span><span class="line">            <span class="nt">&lt;key&gt;</span>SockServiceName<span class="nt">&lt;/key&gt;</span>
</span><span class="line">            <span class="nt">&lt;string&gt;</span>55<span class="nt">&lt;/string&gt;</span>
</span><span class="line">        <span class="nt">&lt;/dict&gt;</span>
</span><span class="line">    <span class="nt">&lt;/dict&gt;</span>
</span><span class="line"><span class="nt">&lt;/dict&gt;</span>
</span><span class="line"><span class="nt">&lt;/plist&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>最后，将 plist 文件 scp 至 <code>root@192.168.1.114:/System/Library/LaunchDaemons/</code>下 。</p>

<h3>编写读取 iTunesstore 数据库程序</h3>

<p>读取 itunesstored2.sqlitedb 信息，并输出到 stdout 中，便于我们读取。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#include &lt;stdio.h&gt;  </span>
</span><span class="line"> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">fcntl</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class="line"> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"> <span class="err">#</span><span class="n">define</span> <span class="n">FILE</span> <span class="s">&quot;/var/mobile/Library/com.apple.itunesstored/itunesstored2.sqlitedb&quot;</span>
</span><span class="line">
</span><span class="line"><span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">FILE</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span><span class="line">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class="line">    <span class="k">while</span> <span class="p">((</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class="line">        <span class="n">write</span><span class="p">(</span> <span class="n">fileno</span><span class="p">(</span><span class="n">stdout</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class="line">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>编译、拷贝、签名</h3>

<h4>编译方法上篇文章已经介绍清楚，这里不再重复，直接 ￥%￥＃%￥……%＃ 生成运行在 ARM 的 ncdemo</h4>

<h4>将 ncdemo scp 到设备中，并登录</h4>

<div class="code code">
<pre class="code">$ scp ncdemo root@192.168.1.114:ncdemo
$ ssh root@192.168.1.114</pre>
</div>

<h4>签名</h4>

<div class="code code">
<pre class="code"> #ldid -S ncdemo
 #mv ncdemo /usr/bin</pre>
</div>

<h3>抓取 iTunesstore 数据信息</h3>

<p>这时，我们只需要利用 netcat，指定之前定义的服务名称，轻松在本地抓取设备 iTunesstore 信息.
<code>$ nc 192.168.1.114 55 &gt; itunesstored2.sqlitedb</code></p>

<h3>分析 iTunesstore 数据信息</h3>

<p>好吧，这里就介绍个最简单的应用，利用string命令查看：
<code>$ strings itunesstored2.sqlitedb</code></p>

<p>于是乎，我们就清晰的得到了 iPhone/iPad 设备上都安装了哪些 app ：</p>

<div class="figure" id="figure-2-2">
    <img src="http://ww1.sinaimg.cn/large/626e5d69gw1f74ol56kfgj20df0gfgpo.jpg" />

    <p class="caption"><strong>图片 2.2</strong> daemon2</p>
</div>


<p>当然，除了这些，你想干什么都可以……夜深了，先写到这里吧……</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/24/ru-he-fei-fa-qie-qu-yong-hu-xin-xi-%3F/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/19/ioshei-ke-gong-ju/">
		
			iOS黑客工具</a>
	</h2>
	<div class="entry-content">
		<div class="container">
<div class="item chapter">
    <h1 class="title"><span class="label">1</span> <span class="title">Hack 必备的命令与工具</span></h1>
    <h3>常用的命令和工具</h3>

<p>ps              ——显示进程状态，CPU 使用率，内存使用情况等<br />
sysctl       ——检查设定 Kernel 配置<br />
netstat     ——显示网络连接，路由表，接口状态等<br />
route        ——路由修改<br />
renice       ——调整程序运行的优先级<br />
ifconfig    ——查看网络配置<br />
tcpdump   ——截获分析网络数据包<br />
lsof           ——列出当前系统打开的文件列表，别忘记一切皆文件，包括网络连接、硬件等<br />
otool ①     ——查看程序依赖哪些动态库信息，反编代码段……等等等等<br />
nm ②        ——显示符号表<br />
ldid ③      ——签名工具<br />
gdb          ——调试工具
patch       ——补丁工具<br />
SSH         ——远程控制</p>

<p>备注：
① otool，可查看可执行程序都链接了那些库：
 <code>otool  -L WQAlbum</code></p>

<p>可以得到：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class=""><span class="line">WQAlbum:
</span><span class="line">    /System/Library/Frameworks/StoreKit.framework/StoreKit (compatibility version 1.0.0, current version 1.0.0)
</span><span class="line">    /System/Library/Frameworks/AdSupport.framework/AdSupport (compatibility version 1.0.0, current version 1.0.0)
</span><span class="line">    /usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.5)
</span><span class="line">    /System/Library/Frameworks//MediaPlayer.framework/MediaPlayer (compatibility version 1.0.0, current version 1.0.0)
</span><span class="line">    /System/Library/Frameworks/MobileCoreServices.framework/MobileCoreServices (compatibility version 1.0.0, current version 40.0.0)
</span><span class="line">    /System/Library/Frameworks/CoreMedia.framework/CoreMedia (compatibility version 1.0.0, current version 1.0.0)
</span><span class="line">……</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>可以反编译 WQAlbum 的 <code>__TEXT__</code> 段内容, 截前 10 行：
<code>otool -tV WQAlbum |head -n 10</code></p>

<p>可以得到：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class=""><span class="line">WQAlbum:
</span><span class="line">(__TEXT,__text) section
</span><span class="line">start:
</span><span class="line">00002de0    pushl    $0x00
</span><span class="line">00002de2    movl    %esp,%ebp
</span><span class="line">00002de4    andl    $0xf0,%esp
</span><span class="line">00002de7    subl    $0x10,%esp
</span><span class="line">00002dea    movl    0x04(%ebp),%ebx
</span><span class="line">……</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>② nm，显示程序符号表，用我自己的应用程序私人相册现身说法一下：
<code>nm -g WQAlbum  （ -g 代表 global ）</code></p>

<p>可以得到：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">001e5eec S _OBJC_IVAR_$_WQPhotoViewController.albumObject
</span><span class="line">001e5efc S _OBJC_IVAR_$_WQPhotoViewController.int_current
</span><span class="line">001e5f00 S _OBJC_IVAR_$_WQPhotoViewController.int_total</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>其中，WQPhotoViewController 为类名，albumObject 为该类的成员</p>

<p>③ ldid，是 iPhoneOS.platform 提供的签名工具，我们自己编译的程序需要签上名才能跑在 iPhone/iPad 上，使用方法</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">export CODESIGN_ALLOCATE=/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/codesign_allocate
</span><span class="line">ldid -S helloworld</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>编译 Hello World</h3>

<h4>首先找到编译器：</h4>

<div class="figure" id="figure-1-1">
    <img src="http://ww3.sinaimg.cn/large/626e5d69gw1f6z8vi0nwej20sg04rjuo.jpg" />

    <p class="caption"><strong>图片 1.1</strong> hacktools1</p>
</div>


<p><code>arm-apple-darwin10-llvm-gcc-4.2</code> 就是了。
为了方便起见，可以在 <code>.bashrc</code> 或者 <code>profile</code> 配置下环境变量，方便编译。</p>

<h4>找到 SDK</h4>

<p>编译我们自己的程序的时候需要指定该目录下的 SDK 。</p>

<h4>来个经典 Hello World ：</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="cp">#include &lt;stdio.h&gt;                                                                                            </span>
</span><span class="line"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span><span class="line">       <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello world !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class="line">       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4>编译</h4>

<div class="figure" id="figure-1-2">
    <img src="http://ww4.sinaimg.cn/large/626e5d69jw1f6z8wxuoppj20p202b3zt.jpg" alt="hacktools2" />

    <p class="caption"><strong>图片 1.2</strong> hacktools2</p>
</div>


<p>其中 -isysroot 用来指定 build 时的 SDK</p>

<h4>校验</h4>

<div class="figure" id="figure-1-3">
    <img src="http://ww4.sinaimg.cn/large/626e5d69jw1f6z8y87hmhj20sg026759.jpg" alt="hacktools3" />

    <p class="caption"><strong>图片 1.3</strong> hacktools3</p>
</div>


<p>file 查看一下类型，没问题。</p>

<h4>SCP 给 iPhone、iPad</h4>

<p>前提是，设备已经越狱并且安装了 SSH ,且必须在同一网段。
<code>$scp helloworld root@x.x.x.x:hello world</code></p>

<h4>登录设备签名</h4>

<p><code>$ssh -l root x.x.x.x</code></p>

<p><code>#ldid -S helloworld</code></p>

<h4>执行程序</h4>

<div class="code code">
<pre class="code"> #./helloworld
Hello world !!!</pre>
</div>

<p>运行成功，这就完成了最简单的手动执行自己的应用程序。</p>

</div>
</div>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">


	<a class='category' href='/Blog/blog/categories/ios/'>iOS</a>


</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/19/ioshei-ke-gong-ju/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/18/xun-huan-yin-yong-hui-dao-zhi-beng-kui-ma-%3F/">
		
			循环引用会导致崩溃吗？</a>
	</h2>
	<div class="entry-content">
		<p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="err">@</span><span class="n">weakify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class="line">   <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span> <span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">       <span class="err">@</span><span class="n">strongify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class="line">       <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class="line">   <span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
在 <code>block</code> 没有调用前, <code>self delloc</code>了,在<code> block </code>里面<code> strongself </code>应该可以获取的变量，个人理解,<code>block </code>中的<code> self </code>算是局部变量,有<code> block </code>持有,销毁情况只跟<code> block </code>有关系</p>
<p>也有人说<code> strongSelf </code>只是保证在<code> block </code>里面有值，这样说也没错，我测试也是<code> strong </code>里面保持有值得，即使外部的<code> self </code>释放了，所以内部才用<code> strongSelf </code>啦</p>
<p>那平常我们在没有用这个框架的时候,都是用__weak,这样的话,<code> block </code>里边的<code>weakself</code>,在<code>self dealloc</code>后 , 还有么？dealloc 会置为 nil
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="n">__weak</span> <span class="n">typeof</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="n">weakself</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class="line">    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span> <span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class="line">    <span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>对于内部有多函数调用 用它有隐患,也就是说这样写,是不好的？</p>
<p>是的,这样可以避免<code>block</code>执行过程中<code>self</code>对象被释放</p>
<p>外部的 <code>weak</code> 是为了防止因为<code> self </code>导致的循环引用,但是如果这时候<code> self </code>被释放的话,内部的<code> weakself </code>就为空了,所以一般内部会用<code> __strong </code>生声明一下<code> __weak typeof(self) weakSelf = self; </code>最安全用法:block外部:<code>  __weak __typeof(self) weakSelf = self; </code>block内部:<code> __strong __typeof(weakSelf) strongSelf = weakSelf; </code>why:<code> weakSelf </code>是为了<code>block</code>不持有<code>self</code>, 避免循环引用, 而再声明一个<code>strongSelf</code>是因为一旦进入<code>block</code>执行, 就不允许<code>self</code>在这个执行过程中释放.<code> block</code>执行完成后这个<code>strongSelf</code>会自动释放, 没有循环引用问题.
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line">  <span class="n">__weak</span> <span class="n">typeof</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="n">weakSelf</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class="line">  <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class="line">    <span class="p">[</span><span class="n">weakSelf</span> <span class="n">doThis</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">weakSelf</span> <span class="n">doThat</span><span class="p">];</span>
</span><span class="line">    <span class="p">[</span><span class="n">Manager</span><span class="p">.</span><span class="n">sharedInstance</span> <span class="n">updateSuccessCount</span><span class="p">];</span>
</span><span class="line">  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
如上,<code>block</code>内部发送了两条消息, 如果只是一条, 那么采用<code>weakSelf</code>是没有问题的.但如果是两条消息,y通过看<code>Clang</code>的document能够看到, 以为<code>Clang</code>有可能会重新计算对象的引用计数, <code>weakSelf</code>有可能被置为nil, 这一过程发生在<code>block</code>内部执行完doThis之后, 还没有执行doThat之前.
我现在这外部<code> weakself </code>释放了,里面的<code> strongself </code>也跟着释放了.
<br />
<img src="http://ww4.sinaimg.cn/large/626e5d69gw1f6y6tdb3mvj20ks06ejso.jpg" alt="" />
<br />
那么这里用<code>weakself  </code>是不是不对呢？
刚才那里用<code>weakSelf</code>是没错的。为什么？
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="n">__weak</span> <span class="n">typeof</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="n">weakSelf</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class="line"><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class="line">      <span class="k">if</span><span class="p">(</span><span class="n">weakSelf</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">      <span class="n">__strong</span> <span class="n">typeof</span><span class="p">(</span><span class="n">weakSelf</span><span class="p">)</span> <span class="n">strongSelf</span> <span class="o">=</span> <span class="n">weakSelf</span><span class="p">;</span>
</span><span class="line">      <span class="p">[</span><span class="n">strongSelf</span> <span class="n">doThis</span><span class="p">];</span>
</span><span class="line">      <span class="p">[</span><span class="n">weakSelf</span> <span class="n">doThat</span><span class="p">];</span>
</span><span class="line">      <span class="p">[</span><span class="n">Manager</span><span class="p">.</span><span class="n">sharedInstance</span> <span class="n">updateSuccessCount</span><span class="p">];</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
内部的<code>typeof()</code>括号里面的是<code> weakSelf</code>啦
这样<code>block</code>会把<code>weakSelf</code>放到内部的一个持有变量表里面,我测试,当在内部强引用这<code> self</code>, 视图被销毁,先走 <code>delloc</code>, 然后<code> strongself </code>还是存在的。
不是有一个持有变量表么,按道理来讲<code>block</code>中的<code>weakself</code>,应该是一直有的啊<code>block</code>持有<code>weakSelf</code>，因为是<code>weak</code>变量所以不会增加引用计数。如果<code>self</code>对象在<code>block</code>执行之前就没有其他<code>strong</code>变量持有它，就会释放，后面<code>block</code>执行的时候<code>weakSelf</code>就已经是<code>nil</code>了。但是如果<code>block</code>开始执行，<code>strongSelf</code>又持有了<code>self</code>对象，这时候即使没有其他<code>strong</code>变量持有，<code>self</code>对象也不会释放。<code>block</code>执行完毕后，局部变量<code>strongSelf</code>被系统自动回收，这时候<code>self</code>变量引用计数会-1，如果没有其他变量持有，就会释放。总之，<code>strongSelf</code>不能确保<code>block</code>执行时<code>self</code>对象还存在，但是一旦开始执行时<code>self</code>还在，<code>strongSelf</code>可以给<code>self</code>续命到<code>block</code>执行结束
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="objc"><span class="line"><span class="n">__weak</span> <span class="n">typeof</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="n">weakSelf</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class="line"><span class="p">[</span><span class="n">self</span> <span class="nl">doSomethingInBackgroundWithBlock:</span><span class="o">^</span><span class="p">{</span>
</span><span class="line">    <span class="n">__strong</span> <span class="n">typeof</span><span class="p">(</span><span class="n">weakSelf</span><span class="p">)</span> <span class="n">strongSelf</span> <span class="o">=</span> <span class="n">weakSelf</span><span class="p">;</span>
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">strongSelf</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="p">[</span><span class="n">strongSelf</span> <span class="n">doSomethingInBlock</span><span class="p">];</span>
</span><span class="line">        <span class="p">[</span><span class="n">strongSelf</span> <span class="n">doSomethingElseInBlock</span><span class="p">];</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>其实这里不if 倒也没关系，反正给nil发消息什么也不会发生。不过加上逻辑更明确。发送消息没关系，但是访问他的变量就完了
<img src="http://ww1.sinaimg.cn/large/626e5d69gw1f6y6vf2fhpj209204pgm4.jpg" alt="" />
<br />
这个就会崩溃。
嗯，循环引用大致是这样
</p>
<p class="post-footer">
                        written by <a href="http://ITMonkeyLife.github.io/Blog">Rick</a>&nbsp;posted at <a href="http://ITMonkeyLife.github.io/Blog">http://ITMonkeyLife.github.io/Blog</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">

</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/18/xun-huan-yin-yong-hui-dao-zhi-beng-kui-ma-%3F/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/08/18/javascriptde-zuo-yong-yu/">
		
			JavaScript的作用域</a>
	</h2>
	<div class="entry-content">
		<script type="text/javascript">

    function switchStylestyle(styleName) {
        $('link[rel*=style][title]').each(function (i) {
            this.disabled = true;
            if (this.getAttribute('title') == styleName) this.disabled = false;
        });
    }

    $(function () {
        $('.markdown-body pre').addClass('prettyprint');
        prettyPrint();

        $(".markdown-body pre").each(function () {
            var lines = $(this).attr("data-strong-lines");
            if (lines == undefined || lines == "")
                return;
            var nums = lines.split(' ');
            if (nums.length > 0)
                for (var i = 0; i < nums.length; i++) {
                    $(this).find("li:nth-child(" + nums[i] + ")").addClass("strong-code-line");
                }
        });

    });


</script>

<h1>　作用域是什么</h1>
<p>几乎所有编程语言最基本的功能之一，就是能够储存变量当中的值，并且能在之后对这个值进行访问或修改。事实上，正是这种储存和访问变量的值的能力将<strong>状态</strong>带给了程序。</p>
<p>若没有了状态这个概念，程序虽然也能够执行一些简单的任务，但它会受到高度限制，做不到非常有趣。</p>
<p>但是将变量引入程序会引起几个很有意思的问题，也正是我们将要讨论的：这些变量<strong>住在</strong>哪里？换句话说，它们储存在哪里？最重要的是，程序需要时如何找到它们？</p>
<p>这些问题说明需要一套设计良好的规则来存储变量，并且之后可以方便地找到这些变量。这套规则被称为<strong>作用域</strong>。</p>
<p>但是，究竟在哪里而且怎样设置这些<strong>作用域</strong>的规则呢？</p>
<h2>　编译原理</h2>
<p>尽管通常将JavaScript归类为“动态”或“解释执行”语言，但事实上它是一门编译语言。这个事实对你来说可能显而易见，也可能你闻所未闻，取决于你接触过多少编程语言，具有多少经验。但与传统的编译语言不同，它<strong>不是</strong>提前编译的，编译结果也不能在分布式系统中进行移植。</p>
<p>尽管如此，JavaScript引擎进行编译的步骤和传统的编译语言非常相似，在某些环节可能比预想的要复杂。</p>
<p>在传统编译语言的流程中，程序中的一段源代码在执行<strong>之前</strong>会经历三个步骤，统称为“编译”。</p>
<ul>
<li><p><strong>分词/词法分析</strong>（Tokenizing/Lexing）</p>
<p>这个过程会将由字符组成的字符串分解成（对编程语言来说）有意义的代码块，这些代码块被称为词法单元（token）。例如，考虑程序<code>var a = 2;</code>。这段程序通常会被分解成为下面这些词法单元：<code>var</code>、<code>a</code>、<code>=</code>、<code>2</code> 、<code>;</code>。空格是否会被当作词法单元，取决于空格在这门语言中是否具有意义。</p>
</li>
</ul>
<blockquote>
<p><img src="http://epub.ituring.com.cn/api/storage/getbykey/screenshow?key=1405bfdb7c117638d93d" alt="" width="5%" style="width: 5%" />分词（tokenizing）和词法分析（Lexing）之间的区别是非常微妙、晦涩的，主要差异在于词法单元的识别是通过<strong>有状态</strong>还是<strong>无状态</strong>的方式进行的。简单来说，如果词法单元生成器在判断<code>a</code>是一个独立的词法单元还是其他词法单元的一部分时，调用的是有状态的解析规则，那么这个过程就被称为<strong>词法分析</strong>。</p>
</blockquote>
<ul>
<li><p><strong>解析/语法分析</strong>（Parsing）</p>
<p>这个过程是将词法单元流（数组）转换成一个由元素逐级嵌套所组成的代表了程序语法结构的树。这个树被称为“抽象语法树”（Abstract Syntax Tree，AST）。</p>
<p><code>var a = 2;</code>的抽象语法树中可能会有一个叫作<code>VariableDeclaration</code>的顶级节点，接下来是一个叫作<code>Identifier</code>（它的值是<code>a</code>）的子节点，以及一个叫作<code>AssignmentExpression</code>的子节点。<code>AssignmentExpression</code>节点有一个叫作<code>NumericLiteral</code>（它的值是<code>2</code>）的子节点。</p>
</li>
</ul>
<ul>
<li><p><strong>代码生成</strong></p>
<p>将AST转换为可执行代码的过程称被称为代码生成。这个过程与语言、目标平台等息息相关。</p>
<p>抛开具体细节，简单来说就是有某种方法可以将<code>var a = 2;</code>的AST转化为一组机器指令，用来<strong>创建</strong>一个叫作<code>a</code>的变量（包括分配内存等），并将一个值储存在<code>a</code>中。</p>
</li>
</ul>
<blockquote>
<p><img src="http://epub.ituring.com.cn/api/storage/getbykey/screenshow?key=1405bfdb7c117638d93d" alt="" width="5%" style="width: 5%" />关于引擎如何管理系统资源超出了我们的讨论范围，因此只需要简单地了解引擎可以根据需要创建并储存变量即可。</p>
</blockquote>

		
		<a href="/Blog/blog/2016/08/18/javascriptde-zuo-yong-yu/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">

</div>
	
	<div class="comments"><a href="/Blog/blog/2016/08/18/javascriptde-zuo-yong-yu/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/Blog/blog/2016/06/15/swift-3-dot-0-abi/">
		
			Swift 3.0 ABI</a>
	</h2>
	<div class="entry-content">
		<h2><a class="toc-backref" href="#id2">Hard Constraints on Resilience</a><a class="headerlink" href="#hard-constraints-on-resilience" title="Permalink to this headline"></a></h2>
<p>The root of a class hierarchy must remain stable, at pain of
invalidating the metaclass hierarchy.  Note that a Swift class without an
explicit base class is implicitly rooted in the SwiftObject
Objective-C class.</p>

<h2><a class="toc-backref" href="#id3">Type Layout</a><a class="headerlink" href="#type-layout" title="Permalink to this headline"></a></h2>
<div class="section" id="fragile-struct-and-tuple-layout">
<h3><a class="toc-backref" href="#id4">Fragile Struct and Tuple Layout</a><a class="headerlink" href="#fragile-struct-and-tuple-layout" title="Permalink to this headline"></a></h3>
<p>Structs and tuples currently share the same layout algorithm, noted as the
&#8220;Universal&#8221; layout algorithm in the compiler implementation. The algorithm
is as follows:</p>
<ul class="simple">
<li>Start with a <strong>size</strong> of <strong>0</strong> and an <strong>alignment</strong> of <strong>1</strong>.</li>
<li>Iterate through the fields, in element order for tuples, or in <code class="docutils literal"><span class="pre">var</span></code>
declaration order for structs. For each field:<ul>
<li>Update <strong>size</strong> by rounding up to the <strong>alignment of the field</strong>, that is,
increasing it to the least value greater or equal to <strong>size</strong> and evenly
divisible by the <strong>alignment of the field</strong>.</li>
<li>Assign the <strong>offset of the field</strong> to the current value of <strong>size</strong>.</li>
<li>Update <strong>size</strong> by adding the <strong>size of the field</strong>.</li>
<li>Update <strong>alignment</strong> to the max of <strong>alignment</strong> and the
<strong>alignment of the field</strong>.</li>
</ul>
</li>
<li>The final <strong>size</strong> and <strong>alignment</strong> are the size and alignment of the
aggregate. The <strong>stride</strong> of the type is the final <strong>size</strong> rounded up to
<strong>alignment</strong>.</li>
</ul>
<p>Note that this differs from C or LLVM&#8217;s normal layout rules in that <em>size</em>
and <em>stride</em> are distinct; whereas C layout requires that an embedded struct&#8217;s
size be padded out to its alignment and that nothing be laid out there,
Swift layout allows an outer struct to lay out fields in the inner struct&#8217;s
tail padding, alignment permitting. Unlike C, zero-sized structs and tuples
are also allowed, and take up no storage in enclosing aggregates. The Swift
compiler emits LLVM packed struct types with manual padding to get the
necessary control over the binary layout. Some examples:</p>
<pre>// LLVM &lt;{ i64, i8 }&gt;
struct S {
  var x: Int
  var y: UInt8
}

// LLVM &lt;{ i8, [7 x i8], &lt;{ i64, i8 }&gt;, i8 }&gt;
struct S2 {
  var x: UInt8
  var s: S
  var y: UInt8
}

// LLVM &lt;{}&gt;
struct Empty {}

// LLVM &lt;{ i64, i64 }&gt;
struct ContainsEmpty {
  var x: Int
  var y: Empty
  var z: Int
}
</pre></div>

<h3><a class="toc-backref" href="#id5">Class Layout</a><a class="headerlink" href="#class-layout" title="Permalink to this headline"></a></h3>
<p>Swift relies on the following assumptions about the Objective-C runtime,
which are therefore now part of the Objective-C ABI:</p>
<ul class="simple">
<li>32-bit platforms never have tagged pointers.  ObjC pointer types are
either nil or an object pointer.</li>
<li>On x86-64, a tagged pointer either sets the lowest bit of the pointer
or the highest bit of the pointer.  Therefore, both of these bits are
zero if and only if the value is not a tagged pointer.</li>
<li>On ARM64, a tagged pointer always sets the highest bit of the pointer.</li>
<li>32-bit platforms never perform any isa masking.  <code class="docutils literal"><span class="pre">object_getClass</span></code>
is always equivalent to <code class="docutils literal"><span class="pre">*(Class*)object</span></code>.</li>
<li>64-bit platforms perform isa masking only if the runtime exports a
symbol <code class="docutils literal"><span class="pre">uintptr_t</span> <span class="pre">objc_debug_isa_class_mask;</span></code>.  If this symbol
is exported, <code class="docutils literal"><span class="pre">object_getClass</span></code> on a non-tagged pointer is always
equivalent to <code class="docutils literal"><span class="pre">(Class)(objc_debug_isa_class_mask</span> <span class="pre">&amp;</span> <span class="pre">*(uintptr_t*)object)</span></code>.</li>
<li>The superclass field of a class object is always stored immediately
after the isa field.  Its value is either nil or a pointer to the
class object for the superclass; it never has other bits set.</li>
</ul>
<p>The following assumptions are part of the Swift ABI:</p>
<ul class="simple">
<li>Swift class pointers are never tagged pointers.</li>
</ul>
<p>TODO</p>
<h3><a class="toc-backref" href="#id6">Fragile Enum Layout</a><a class="headerlink" href="#fragile-enum-layout" title="Permalink to this headline"></a></h3>
<p>In laying out enum types, the ABI attempts to avoid requiring additional
storage to store the tag for the enum case. The ABI chooses one of five
strategies based on the layout of the enum:</p>
<h4><a class="toc-backref" href="#id7">Empty Enums</a><a class="headerlink" href="#empty-enums" title="Permalink to this headline"></a></h4>
<p>In the degenerate case of an enum with no cases, the enum is an empty type.</p>
<pre><span class="n">enum</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// =&gt; empty type</span>
</pre>
<h4><a class="toc-backref" href="#id8">Single-Case Enums</a><a class="headerlink" href="#single-case-enums" title="Permalink to this headline"></a></h4>
<p>In the degenerate case of an enum with a single case, there is no
discriminator needed, and the enum type has the exact same layout as its
case&#8217;s data type, or is empty if the case has no data type.</p>
<pre><span class="n">enum</span><span class="w"> </span><span class="n">EmptyCase</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">case</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="p">}</span><span class="w">             </span><span class="c1">// =&gt; empty type</span>
<span class="n">enum</span><span class="w"> </span><span class="n">DataCase</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">case</span><span class="w"> </span><span class="no">Y</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// =&gt; LLVM &lt;{ i64, double }&gt;</span>
</pre>

		
		<a href="/Blog/blog/2016/06/15/swift-3-dot-0-abi/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">




</div>
	<div class="tags">

</div>
	
	<div class="comments"><a href="/Blog/blog/2016/06/15/swift-3-dot-0-abi/#disqus_thread">Comments</a></div>
	
</div>
</article>

<nav id="pagenavi">
    
        
            <a href="/Blog/blog/page/2/" class="prev">Prev</a>
        
    
    
        <a href="/Blog/blog/page/4/" class="next">Next</a>
    
    <div class="center"><a href="/Blog/blog/archives">Blog Archives</a></div>
</nav>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2016

    Rick

</footer>
	<script src="/Blog/javascripts/slash.js"></script>
<script src="/Blog/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'ITMonkeyLife';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-52658428-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>